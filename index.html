<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç«¹åŒ—é‹å‹•ä¸­å¿ƒç‡ŸéšŠå ±å</title>
    <!-- LIFF SDK -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <!-- Vue 3 (æ›´æ›ç‚º cdnjs ä»¥æå‡ç©©å®šåº¦) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* è§£æ±º iOS è¼¸å…¥æ¡†å­—é«”ç¸®æ”¾å•é¡Œ */
        input { font-size: 16px; }
        [v-cloak] { display: none; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 min-h-screen text-gray-800">

<div id="app" v-cloak class="max-w-md mx-auto bg-white min-h-screen shadow-lg flex flex-col">
    
    <!-- å°èˆªåˆ— -->
    <header class="bg-blue-600 text-white p-4 shadow-md sticky top-0 z-10">
        <h1 class="text-lg font-bold">ç«¹åŒ—åœ‹æ°‘é‹å‹•ä¸­å¿ƒ ç‡ŸéšŠå ±å</h1>
        <p class="text-xs opacity-90" v-if="userProfile">Hi, {{ userProfile.displayName }}</p>
    </header>

    <!-- å…§å®¹å€åŸŸ -->
    <main class="flex-grow p-4 space-y-4">

        <!-- ç‹€æ…‹: è¼‰å…¥ä¸­ -->
        <div v-if="isLoading" class="flex flex-col items-center justify-center py-10">
            <div class="loader mb-2"></div>
            <p class="text-sm text-gray-500">è³‡æ–™è¼‰å…¥ä¸­...</p>
        </div>

        <!-- ç‹€æ…‹: LIFF æœªåˆå§‹åŒ–æˆ–éŒ¯èª¤ -->
        <div v-else-if="error" class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded">
            <p class="font-bold">ç™¼ç”ŸéŒ¯èª¤</p>
            <p>{{ error }}</p>
        </div>

        <!-- ä¸»ç•«é¢ -->
        <div v-else>
            
            <!-- èª²ç¨‹åˆ—è¡¨ -->
            <div v-if="view === 'list'" class="space-y-4">
                <h2 class="text-xl font-bold border-b pb-2">ç†±é–€ç‡ŸéšŠ</h2>
                
                <div v-for="course in courses" :key="course.id" class="bg-white border rounded-lg p-4 shadow-sm hover:shadow-md transition">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-bold text-lg text-blue-800">{{ course.name }}</h3>
                        <span class="bg-blue-100 text-blue-800 text-xs font-semibold px-2 py-1 rounded">
                            ${{ course.price }}
                        </span>
                    </div>
                    <div class="text-sm text-gray-600 space-y-1">
                        <p>ğŸ“… æ—¥æœŸ: {{ formatDate(course.date) }}</p>
                        <p>ğŸ‘¥ åé¡: {{ course.enrolled }} / {{ course.capacity }}</p>
                    </div>
                    
                    <button 
                        @click="selectCourse(course)"
                        :disabled="course.enrolled >= course.capacity"
                        :class="course.enrolled >= course.capacity ? 'bg-gray-300 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700'"
                        class="w-full mt-3 text-white font-bold py-2 px-4 rounded transition">
                        {{ course.enrolled >= course.capacity ? 'å·²é¡æ»¿' : 'ç«‹å³å ±å' }}
                    </button>
                </div>
            </div>

            <!-- å ±åè¡¨å–® -->
            <div v-if="view === 'form'" class="bg-white rounded-lg">
                <button @click="view = 'list'" class="text-sm text-blue-500 mb-4 flex items-center">
                    â† è¿”å›èª²ç¨‹åˆ—è¡¨
                </button>
                
                <h2 class="text-xl font-bold mb-4">{{ selectedCourse.name }}</h2>
                <div class="bg-yellow-50 p-3 rounded text-sm text-yellow-800 mb-4 border border-yellow-200">
                    <p>ğŸ’¡ åœ˜å ±å„ªæƒ ï¼š5äºº95æŠ˜ã€10äºº9æŠ˜ï¼<br>è«‹è¼¸å…¥ç›¸åŒçš„ã€Œåœ˜é«”ä»£ç¢¼ã€å³å¯é€£å‹•å„ªæƒ ã€‚</p>
                </div>

                <form @submit.prevent="submitRegistration" class="space-y-4">
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">çœŸå¯¦å§“å</label>
                        <input type="text" v-model="form.name" required placeholder="è«‹è¼¸å…¥å§“å" class="w-full border border-gray-300 p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">èº«åˆ†è­‰å­—è™Ÿ (å¯¦ååˆ¶)</label>
                        <input type="text" v-model="form.nationalId" required placeholder="A123456789" class="w-full border border-gray-300 p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none uppercase">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">è¯çµ¡é›»è©±</label>
                        <input type="tel" v-model="form.phone" required placeholder="0912345678" class="w-full border border-gray-300 p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">åœ˜é«”ä»£ç¢¼ (é¸å¡«)</label>
                        <input type="text" v-model="form.groupId" placeholder="è‡ªè¡Œè¨­å®š (å¦‚: BADMINTON_TEAM_A)" class="w-full border border-gray-300 p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none">
                        <p class="text-xs text-gray-500 mt-1">è‹¥èˆ‡æœ‹å‹ä¸€èµ·å ±åï¼Œè«‹ç´„å®šä¸€å€‹ä»£ç¢¼ä¸¦å¡«å…¥ç›¸åŒå…§å®¹ã€‚</p>
                    </div>

                    <button type="submit" :disabled="isSubmitting" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded shadow transition flex justify-center items-center">
                        <span v-if="isSubmitting" class="loader w-5 h-5 border-2 mr-2"></span>
                        {{ isSubmitting ? 'è™•ç†ä¸­...' : 'ç¢ºèªå ±å' }}
                    </button>
                </form>
            </div>

            <!-- å ±åæˆåŠŸé  -->
            <div v-if="view === 'success'" class="text-center py-8">
                <div class="w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-4 text-3xl">âœ“</div>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">å ±åæˆåŠŸï¼</h2>
                <p class="text-gray-600 mb-6">{{ successMessage }}</p>
                
                <div class="bg-gray-50 p-4 rounded text-left text-sm space-y-2 mb-6 border">
                    <p><span class="font-bold">è¨‚å–®ç·¨è™Ÿ:</span> {{ orderResult.orderId }}</p>
                    <p><span class="font-bold">æ‡‰ç¹³é‡‘é¡:</span> <span class="text-red-600 font-bold">${{ orderResult.amount }}</span></p>
                    <p><span class="font-bold">ç¹³è²»æœŸé™:</span> {{ formatTime(orderResult.paymentDeadline) }}</p>
                </div>

                <button @click="closeLiff" class="w-full bg-gray-800 text-white font-bold py-3 rounded">
                    é—œé–‰è¦–çª—
                </button>
            </div>

        </div>
    </main>

    <footer class="p-4 text-center text-xs text-gray-400 border-t">
        &copy; 2026 ç«¹åŒ—åœ‹æ°‘é‹å‹•ä¸­å¿ƒ | Powered by LIFF & GAS
    </footer>
</div>

<script>
    // æª¢æŸ¥ Vue æ˜¯å¦è¼‰å…¥æˆåŠŸ
    if (typeof Vue === 'undefined') {
        alert('éŒ¯èª¤ï¼šç„¡æ³•è¼‰å…¥ Vue.js å‡½å¼åº«ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ– CDN è¨­å®šã€‚');
        throw new Error('Vue is not defined');
    }

    const { createApp, ref, onMounted } = Vue;

    // æ‚¨æä¾›çš„è³‡æ–™
    const API_ENDPOINT = 'https://sport-island.fangwl591021.workers.dev/'; 
    const LIFF_ID = '2008786875-7COWtgtL';

    createApp({
        setup() {
            const view = ref('list'); // list, form, success
            const isLoading = ref(true);
            const isSubmitting = ref(false);
            const error = ref('');
            const courses = ref([]);
            const userProfile = ref(null);
            // const idToken = ref(''); // ç§»é™¤ Tokenï¼Œæˆ‘å€‘ç¾åœ¨ä¸éœ€è¦å®ƒä¾†é©—è­‰
            const selectedCourse = ref(null);
            const successMessage = ref('');
            const orderResult = ref({});
            
            const form = ref({
                name: '',
                nationalId: '',
                phone: '',
                groupId: ''
            });

            // åˆå§‹åŒ– LIFF
            const initLiff = async () => {
                try {
                    await liff.init({ liffId: LIFF_ID });
                    if (!liff.isLoggedIn()) {
                        liff.login();
                        return;
                    }
                    
                    const profile = await liff.getProfile();
                    userProfile.value = profile;
                    // idToken.value = liff.getIDToken(); // ä¸éœ€è¦äº†
                    
                    // LIFF æº–å‚™å¥½å¾Œï¼Œæ’ˆå–èª²ç¨‹
                    await fetchCourses();
                } catch (err) {
                    error.value = 'LIFF åˆå§‹åŒ–å¤±æ•—: ' + err.message;
                    isLoading.value = false;
                }
            };

            // å‘¼å«å¾Œç«¯ API (é€é Cloudflare Worker)
            const fetchCourses = async () => {
                try {
                    // ä¿®æ”¹è™•ï¼šç§»é™¤ idTokenï¼ŒGET_COURSES ä¸éœ€è¦ä½¿ç”¨è€…è³‡æ–™
                    const res = await fetch(API_ENDPOINT, {
                        method: 'POST',
                        body: JSON.stringify({
                            action: 'GET_COURSES'
                        })
                    });
                    const json = await res.json();
                    
                    if (json.status === 'success') {
                        courses.value = json.data;
                    } else {
                        throw new Error(json.message);
                    }
                } catch (err) {
                    error.value = 'ç„¡æ³•å–å¾—èª²ç¨‹è³‡æ–™: ' + err.message;
                } finally {
                    isLoading.value = false;
                }
            };

            const selectCourse = (course) => {
                selectedCourse.value = course;
                view.value = 'form';
                // é å¡«å§“å
                if(userProfile.value) {
                    form.value.name = userProfile.value.displayName;
                }
            };

            const submitRegistration = async () => {
                isSubmitting.value = true;
                try {
                    // ä¿®æ”¹è™•ï¼šç§»é™¤ idTokenï¼Œæ”¹å‚³ userProfile ç‰©ä»¶
                    // é€™æ˜¯å¾Œç«¯ç¾åœ¨é æœŸçš„çµæ§‹
                    const requestBody = {
                        action: 'REGISTER',
                        userProfile: {
                            userId: userProfile.value.userId,
                            displayName: userProfile.value.displayName
                        },
                        payload: {
                            courseId: selectedCourse.value.id,
                            ...form.value
                        }
                    };

                    const res = await fetch(API_ENDPOINT, {
                        method: 'POST',
                        body: JSON.stringify(requestBody)
                    });
                    const json = await res.json();

                    if (json.status === 'success') {
                        orderResult.value = json.data;
                        successMessage.value = json.data.message;
                        view.value = 'success';
                    } else {
                        alert('å ±åå¤±æ•—: ' + json.message);
                    }
                } catch (err) {
                    alert('é€£ç·šéŒ¯èª¤: ' + err.message);
                } finally {
                    isSubmitting.value = false;
                }
            };

            const formatDate = (dateString) => {
                return new Date(dateString).toLocaleDateString('zh-TW');
            };

            const formatTime = (isoString) => {
                if(!isoString) return '';
                return new Date(isoString).toLocaleString('zh-TW');
            };

            const closeLiff = () => {
                liff.closeWindow();
            };

            onMounted(() => {
                initLiff();
            });

            return {
                view, isLoading, isSubmitting, error, courses, userProfile,
                selectedCourse, form, successMessage, orderResult,
                selectCourse, submitRegistration, formatDate, formatTime, closeLiff
            };
        }
    }).mount('#app');
</script>
</body>
</html>
