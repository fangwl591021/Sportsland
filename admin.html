<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>運動島管理後台</title>
    <!-- Vue 3 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Noto Sans TC -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        /* 強制隱藏尚未載入的 Vue 畫面，解決畫面閃爍與 {{ }} 外露的問題 */
        [v-cloak] { display: none !important; }
        
        :root { --line-green: #06C755; --bg-body: #f5f6f8; --text-main: #111827; }
        body { font-family: 'Noto Sans TC', sans-serif; background: var(--bg-body); color: var(--text-main); overflow: hidden; }

        /* Login Card */
        .login-wrap { position: fixed; inset: 0; background: linear-gradient(135deg, #f0fdf4 0%, #ffffff 100%); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .login-card { background: white; padding: 48px; width: 420px; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.08); border: 1px solid #e5e7eb; text-align: center; }
        .login-logo { width: 72px; height: 72px; background: var(--line-green); border-radius: 18px; color: white; display: flex; align-items: center; justify-content: center; font-size: 32px; margin: 0 auto 24px; box-shadow: 0 4px 12px rgba(6,199,85,0.3); }

        /* 表單與按鈕基礎樣式 */
        .btn-green { background: var(--line-green); color: white; padding: 8px 16px; border-radius: 6px; font-weight: 700; font-size: 14px; display: inline-flex; align-items: center; justify-content: center; gap: 6px; transition: 0.2s; cursor: pointer; }
        .btn-green:hover { background: #05b34c; box-shadow: 0 2px 8px rgba(6,199,85,0.2); }
        .btn-green:disabled { background: #a7f3d0; cursor: not-allowed; }
        .btn-white { background: white; border: 1px solid #d1d5db; color: #374151; padding: 8px 16px; border-radius: 6px; font-weight: 500; font-size: 14px; transition: 0.2s; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 6px;}
        .btn-white:hover { border-color: #06C755; color: #06C755; background-color: #f0fbf5; }
        .input-line { width: 100%; border: 1px solid #d1d5db; border-radius: 6px; padding: 10px 12px; font-size: 14px; outline: none; transition: border 0.2s; background: white; }
        .input-line:focus { border-color: #06C755; box-shadow: 0 0 0 2px rgba(6,199,85,0.1); }
        .input-line:disabled, .input-line:read-only { background-color: #f9fafb; color: #9ca3af; cursor: not-allowed; }
        .label-line { display: block; font-size: 12px; font-weight: 700; color: #6b7280; margin-bottom: 6px; }

        /* Modal 動畫與樣式 */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s; }
        .fade-enter-from, .fade-leave-to { opacity: 0; transform: scale(0.98); }
        .settings-box { background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-bottom: 16px; }
        
        /* Toggle Switch */
        .toggle-switch { position: relative; display: inline-block; width: 44px; height: 24px; flex-shrink: 0; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #cbd5e1; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #06C755; }
        input:checked + .slider:before { transform: translateX(20px); }
    </style>
</head>
<body>

<div id="app" v-cloak class="flex h-screen w-full bg-[#f0f2f5]">

    <!-- LOGIN -->
    <div v-if="!isLoggedIn" class="login-wrap">
        <div class="login-card">
            <div class="login-logo"><i class="fas fa-running"></i></div>
            <h1 class="text-2xl font-bold text-gray-800 mb-2">運動島管理後台</h1>
            <p class="text-gray-400 text-sm mb-8">LINE OA 整合管理系統</p>
            <form @submit.prevent="login">
                <div class="text-left mb-6">
                    <label class="label-line">管理密碼</label>
                    <input v-model="password" type="password" class="input-line" placeholder="請輸入密碼">
                </div>
                <button :disabled="isLoading" class="w-full btn-green py-3 text-base">
                    {{ isLoading ? '登入中...' : '登入系統' }}
                </button>
                <p v-if="error" class="text-red-500 text-sm mt-4">{{ error }}</p>
            </form>
        </div>
    </div>

    <!-- MAIN DASHBOARD -->
    <template v-else>
        <!-- SIDEBAR -->
        <aside class="w-64 bg-white border-r border-gray-200 flex flex-col flex-shrink-0 z-50 shadow-sm relative">
            <div class="h-16 flex items-center px-6 border-b border-gray-100 flex-shrink-0">
                <span class="bg-[#06C755] text-white px-2 py-0.5 rounded text-[10px] font-bold tracking-wider mr-2">LINE OA</span>
                <span class="font-bold text-gray-800 text-base tracking-wide">運動島管理</span>
            </div>
            
            <div class="flex-1 overflow-y-auto py-4 flex flex-col gap-1">
                <div class="px-6 pb-2 text-[10px] font-bold text-gray-400 uppercase tracking-widest">MENU</div>
                <a @click="currentTab='courses'" class="flex items-center w-full px-6 py-3.5 text-gray-600 font-medium cursor-pointer transition-colors border-l-4 border-transparent hover:bg-[#f0fbf5] hover:text-[#06C755]" :class="{'bg-[#f0fbf5] !text-[#06C755] !border-[#06C755] font-bold': currentTab==='courses'}">
                    <i class="fas fa-chalkboard-teacher w-6 text-center mr-3 text-lg"></i> 課程管理
                </a>
                <a @click="currentTab='orders'" class="flex items-center w-full px-6 py-3.5 text-gray-600 font-medium cursor-pointer transition-colors border-l-4 border-transparent hover:bg-[#f0fbf5] hover:text-[#06C755]" :class="{'bg-[#f0fbf5] !text-[#06C755] !border-[#06C755] font-bold': currentTab==='orders'}">
                    <i class="fas fa-file-invoice-dollar w-6 text-center mr-3 text-lg"></i> 訂單管理
                </a>
                <a @click="currentTab='members'" class="flex items-center w-full px-6 py-3.5 text-gray-600 font-medium cursor-pointer transition-colors border-l-4 border-transparent hover:bg-[#f0fbf5] hover:text-[#06C755]" :class="{'bg-[#f0fbf5] !text-[#06C755] !border-[#06C755] font-bold': currentTab==='members'}">
                    <i class="fas fa-users w-6 text-center mr-3 text-lg"></i> 會員管理
                </a>
            </div>

            <div class="p-4 border-t border-gray-100 bg-gray-50 flex-shrink-0">
                <div class="flex items-center gap-3 mb-3 px-2">
                    <div class="w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center text-xs font-bold text-white shadow-inner">A</div>
                    <span class="text-sm font-bold text-gray-600">系統管理員</span>
                </div>
                <button @click="logout" class="w-full btn-white text-xs py-1.5 hover:!border-red-500 hover:!text-red-500 hover:!bg-red-50">登出系統</button>
            </div>
        </aside>

        <!-- CONTENT -->
        <!-- min-w-0 是讓 flex 子元素能正確收縮擴張的關鍵 -->
        <main class="flex-1 flex flex-col min-w-0 overflow-hidden bg-[#f0f2f5] relative">
            <header class="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-8 flex-shrink-0 z-10">
                <h2 class="text-xl font-bold text-gray-800 pl-3 border-l-4 border-[#06C755] leading-none">{{ tabName }}</h2>
                <button @click="fetchData" class="btn-white text-gray-500 hover:text-[#06C755] py-1.5">
                    <i class="fas fa-sync-alt" :class="{'fa-spin':isLoading}"></i> 資料同步
                </button>
            </header>

            <!-- 內容捲動區，w-full 確保展開滿版 -->
            <div class="flex-1 overflow-y-auto p-8 w-full">
                
                <!-- COURSES TAB -->
                <div v-if="currentTab==='courses'" class="w-full max-w-[1600px] mx-auto">
                    <div class="flex justify-between items-end mb-6">
                        <div class="flex gap-4">
                            <div class="bg-white px-6 py-4 rounded-lg border border-gray-200 shadow-sm flex flex-col min-w-[120px]">
                                <span class="text-xs text-gray-400 font-bold uppercase tracking-wider">上架課程</span>
                                <span class="text-3xl font-black text-gray-800 mt-1">{{ courses.length }}</span>
                            </div>
                            <div class="bg-white px-6 py-4 rounded-lg border border-gray-200 shadow-sm flex flex-col min-w-[120px]">
                                <span class="text-xs text-gray-400 font-bold uppercase tracking-wider">總報名人數</span>
                                <span class="text-3xl font-black text-[#06C755] mt-1">{{ totalEnrolled }}</span>
                            </div>
                        </div>
                        <button @click="openAddCourse" class="btn-green shadow-md"><i class="fas fa-plus"></i> 新增課程</button>
                    </div>

                    <!-- 表格卡片：w-full 強制滿寬 -->
                    <div class="bg-white border border-gray-200 rounded-lg shadow-sm w-full overflow-hidden">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-gray-50 text-gray-500 text-xs uppercase tracking-wider border-b border-gray-200">
                                    <th class="px-6 py-4 font-bold">課程資訊</th>
                                    <th class="px-6 py-4 font-bold">類型 / 時間</th>
                                    <th class="px-6 py-4 font-bold">教練 / 費用</th>
                                    <th class="px-6 py-4 font-bold text-center">繳費狀態</th>
                                    <th class="px-6 py-4 font-bold text-right">操作</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100">
                                <tr v-for="c in courses" :key="c.id" class="hover:bg-[#fcfcfc] transition-colors">
                                    <td class="px-6 py-4 w-1/3">
                                        <div class="font-bold text-base text-gray-800">{{ c.name }}</div>
                                        <div class="text-xs text-gray-400 font-mono mt-1 bg-gray-100 inline-block px-1.5 py-0.5 rounded">{{ c.id }}</div>
                                    </td>
                                    <td class="px-6 py-4">
                                        <div class="flex gap-2 mb-1.5">
                                            <span class="text-[11px] font-bold px-2 py-0.5 rounded border"
                                                  :class="{
                                                      'bg-blue-50 text-blue-600 border-blue-100': c.type === '單日課程',
                                                      'bg-orange-50 text-orange-600 border-orange-100': c.type === '多日營隊',
                                                      'bg-purple-50 text-purple-600 border-purple-100': c.type === '常態課後' || !c.type
                                                  }">
                                                {{ c.type || '單日課程' }}
                                            </span>
                                            <span class="text-[11px] font-bold bg-gray-100 text-gray-600 px-2 py-0.5 rounded border border-gray-200">{{ c.timeSlotType }}</span>
                                        </div>
                                        <div class="text-sm text-gray-600">{{ formatDate(c.startDate) }} ~ {{ formatDate(c.endDate) }}</div>
                                    </td>
                                    <td class="px-6 py-4">
                                        <div class="text-sm text-gray-700">{{ c.instructor || '未定' }}</div>
                                        <div class="text-[#06C755] font-bold mt-1 text-base">${{ c.price }}</div>
                                    </td>
                                    <td class="px-6 py-4 text-center">
                                        <!-- 繳費狀態按鈕 -->
                                        <button @click="openUnpaidModal(c)" class="text-sm px-4 py-1.5 rounded-md border font-bold transition-colors w-full max-w-[120px]"
                                                :class="getUnpaidCount(c.id) > 0 ? 'bg-red-50 text-red-600 border-red-200 hover:bg-red-100 shadow-sm' : 'bg-gray-50 text-gray-400 border-gray-200 cursor-default'"
                                                :disabled="getUnpaidCount(c.id) === 0">
                                            未繳費: {{ getUnpaidCount(c.id) }} 人
                                        </button>
                                    </td>
                                    <td class="px-6 py-4 text-right whitespace-nowrap">
                                        <button @click="copyCourse(c)" class="text-gray-400 hover:text-blue-500 p-2 bg-white border border-transparent hover:border-gray-200 rounded transition" title="複製課程"><i class="far fa-copy text-lg"></i></button>
                                        <button @click="openEditCourse(c)" class="text-gray-400 hover:text-[#06C755] p-2 bg-white border border-transparent hover:border-gray-200 rounded transition" title="編輯課程"><i class="fas fa-pen text-lg"></i></button>
                                    </td>
                                </tr>
                                <tr v-if="courses.length === 0">
                                    <td colspan="5" class="px-6 py-12 text-center text-gray-400">目前尚無課程資料</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- ORDERS TAB -->
                <div v-if="currentTab==='orders'" class="w-full max-w-[1600px] mx-auto">
                    <div class="bg-white p-5 rounded-lg border border-gray-200 flex gap-4 shadow-sm mb-6 w-full">
                        <div class="relative flex-1">
                            <i class="fas fa-search absolute left-3 top-3.5 text-gray-400"></i>
                            <input v-model="searchTerm" placeholder="搜尋訂單編號、姓名或電話..." class="input-line pl-10 shadow-none">
                        </div>
                        <select v-model="filterStatus" class="input-line w-48 shadow-none bg-gray-50">
                            <option value="">全部狀態</option>
                            <option value="PENDING">待付款 (PENDING)</option>
                            <option value="PAID">已付款 (PAID)</option>
                            <option value="CANCELLED">已取消 (CANCELLED)</option>
                        </select>
                    </div>
                    <div class="bg-white border border-gray-200 rounded-lg shadow-sm w-full overflow-hidden">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-gray-50 text-gray-500 text-xs uppercase tracking-wider border-b border-gray-200">
                                    <th class="px-6 py-4 font-bold">訂單資訊</th>
                                    <th class="px-6 py-4 font-bold">學員資料</th>
                                    <th class="px-6 py-4 font-bold">金額</th>
                                    <th class="px-6 py-4 font-bold">狀態</th>
                                    <th class="px-6 py-4 font-bold text-right">操作</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100">
                                <tr v-for="o in filteredOrders" :key="o.orderId" class="hover:bg-[#fcfcfc] transition-colors">
                                    <td class="px-6 py-4">
                                        <div class="font-bold text-sm font-mono text-gray-800">{{ o.orderId.slice(0,8) }}</div>
                                        <div class="text-xs text-gray-400 mt-1">{{ formatTime(o.createdAt) }}</div>
                                    </td>
                                    <td class="px-6 py-4">
                                        <div class="font-bold text-gray-800">{{ o.name }}</div>
                                        <div class="text-xs text-gray-500 mt-1"><i class="fas fa-phone mr-1"></i>{{ o.phone }}</div>
                                    </td>
                                    <td class="px-6 py-4 font-bold text-[#06C755] text-base">${{ o.amount }}</td>
                                    <td class="px-6 py-4">
                                        <span class="px-2.5 py-1 rounded text-xs font-bold border" :class="getStatusClass(o.status)">{{ getStatusLabel(o.status) }}</span>
                                    </td>
                                    <td class="px-6 py-4 text-right">
                                        <button @click="openOrder(o)" class="btn-white text-xs py-1.5 px-4 shadow-sm">編輯</button>
                                    </td>
                                </tr>
                                <tr v-if="filteredOrders.length === 0">
                                    <td colspan="5" class="px-6 py-12 text-center text-gray-400">找不到符合的訂單</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- MEMBERS TAB -->
                <div v-if="currentTab==='members'" class="w-full max-w-[1600px] mx-auto">
                    <div class="bg-white p-5 rounded-lg border border-gray-200 flex gap-4 shadow-sm mb-6 w-full">
                        <div class="relative flex-1 max-w-xl">
                            <i class="fas fa-search absolute left-3 top-3.5 text-gray-400"></i>
                            <input v-model="searchTerm" placeholder="搜尋會員姓名、身分證..." class="input-line pl-10 shadow-none">
                        </div>
                    </div>
                    <div class="bg-white border border-gray-200 rounded-lg shadow-sm w-full overflow-hidden">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-gray-50 text-gray-500 text-xs uppercase tracking-wider border-b border-gray-200">
                                    <th class="px-6 py-4 font-bold">姓名</th>
                                    <th class="px-6 py-4 font-bold">身分證字號</th>
                                    <th class="px-6 py-4 font-bold text-center">附屬家人數</th>
                                    <th class="px-6 py-4 font-bold text-right">操作</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100">
                                <tr v-for="u in filteredUsers" :key="u.userId" class="hover:bg-[#fcfcfc] transition-colors">
                                    <td class="px-6 py-4 font-bold text-gray-800">{{ u.name }}</td>
                                    <td class="px-6 py-4 font-mono text-gray-600">{{ u.nationalId }}</td>
                                    <td class="px-6 py-4 text-center">
                                        <span class="bg-blue-50 text-blue-600 border border-blue-100 px-3 py-1 rounded-full text-xs font-bold">{{ u.familyMembers?.length || 0 }}</span>
                                    </td>
                                    <td class="px-6 py-4 text-right">
                                        <button @click="openMember(u)" class="text-[#06C755] font-bold text-sm bg-[#f0fbf5] hover:bg-[#e0f5ea] px-4 py-1.5 rounded transition-colors">查看詳情</button>
                                    </td>
                                </tr>
                                <tr v-if="filteredUsers.length === 0">
                                    <td colspan="4" class="px-6 py-12 text-center text-gray-400">找不到符合的會員</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </main>
    </template>

    <!-- *** MODALS (全部重構為 Tailwind 置中滿版) *** -->

    <!-- 0. 未繳費者名單 Modal -->
    <transition name="fade">
    <div v-if="showUnpaidModal" class="fixed inset-0 bg-black/60 z-[9999] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-2xl max-h-[90vh] rounded-xl shadow-2xl flex flex-col overflow-hidden">
            <div class="h-16 px-6 border-b border-gray-200 flex justify-between items-center bg-white shrink-0">
                <h3 class="text-lg font-bold text-gray-800"><i class="fas fa-users text-red-500 mr-2"></i>未繳費名單 - {{ unpaidCourseName }}</h3>
                <button @click="showUnpaidModal=false" class="text-gray-400 hover:text-gray-600 p-2"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto p-6 bg-[#fafafa]">
                <div v-if="unpaidList.length === 0" class="text-center text-gray-500 py-10 bg-white rounded border border-dashed border-gray-300">目前無未繳費者</div>
                <div v-else class="space-y-3">
                    <div v-for="u in unpaidList" :key="u.orderId" class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm flex justify-between items-center hover:border-red-200 transition-colors">
                        <div>
                            <div class="font-bold text-gray-800 text-base">{{ u.name }}</div>
                            <div class="text-sm text-gray-500 mt-1"><i class="fas fa-phone mr-1"></i>{{ u.phone }}</div>
                            <div class="text-xs text-gray-400 font-mono mt-1 bg-gray-50 inline-block px-1 rounded">單號: {{ u.orderId.slice(0,8) }}</div>
                        </div>
                        <div class="text-right flex flex-col items-end">
                            <div class="font-bold text-[#06C755] text-lg">${{ u.amount }}</div>
                            <div class="text-[11px] bg-yellow-100 text-yellow-800 border border-yellow-200 px-2 py-0.5 rounded mt-1 font-bold">待付款</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="h-16 px-6 border-t border-gray-200 bg-white flex items-center justify-end shrink-0">
                <button @click="showUnpaidModal=false" class="btn-white">關閉視窗</button>
            </div>
        </div>
    </div>
    </transition>

    <!-- 1. COURSE MODAL -->
    <transition name="fade">
    <div v-if="showCourseModal" class="fixed inset-0 bg-black/60 z-[9999] flex items-center justify-center p-4">
        <!-- 最大寬度設為 6xl (約 1152px)，高度 90vh，確保能完整展開 -->
        <div class="bg-white w-full max-w-6xl h-[90vh] rounded-xl shadow-2xl flex flex-col overflow-hidden">
            <div class="h-16 px-8 border-b border-gray-200 flex justify-between items-center bg-white shrink-0">
                <h3 class="text-xl font-bold text-gray-800 flex items-center"><i class="fas fa-chalkboard-teacher text-[#06C755] mr-3"></i>{{ isEditingCourse ? '編輯課程資料' : '新增課程資料' }}</h3>
                <button @click="showCourseModal=false" class="text-gray-400 hover:text-gray-600 p-2"><i class="fas fa-times text-2xl"></i></button>
            </div>
            
            <div class="flex-1 flex overflow-hidden">
                <!-- 左側：基本設定 -->
                <div class="w-1/2 p-8 overflow-y-auto border-r border-gray-200 bg-white">
                    <div class="text-sm font-bold text-gray-800 border-l-4 border-[#06C755] pl-2 mb-6">基本資訊</div>
                    
                    <div class="grid grid-cols-2 gap-6 mb-6">
                        <div><label class="label-line">課程代碼</label><input v-model="courseForm.id" class="input-line" :readonly="isEditingCourse" placeholder="例: 2026-CAMP-001"></div>
                        <div><label class="label-line">課程名稱</label><input v-model="courseForm.name" class="input-line" placeholder="輸入完整課程名稱"></div>
                    </div>

                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-5 mb-6">
                        <div class="grid grid-cols-2 gap-6">
                            <div>
                                <label class="label-line">課程類型</label>
                                <select v-model="courseForm.type" class="input-line">
                                    <option value="單日課程">單日課程 (無退費)</option>
                                    <option value="多日營隊">多日營隊 (可請假)</option>
                                    <option value="常態課後">常態課後 (學期制)</option>
                                </select>
                            </div>
                            <div>
                                <label class="label-line">時段屬性</label>
                                <select v-model="courseForm.timeSlotType" class="input-line">
                                    <option value="全日">全日班</option>
                                    <option value="上午">上午班</option>
                                    <option value="下午">下午班</option>
                                    <option value="晚上">晚上班</option>
                                </select>
                            </div>
                        </div>
                        <div v-if="courseForm.type==='多日營隊'" class="mt-3 text-xs text-orange-600 bg-orange-50 p-2 rounded flex items-start gap-2">
                            <i class="fas fa-exclamation-triangle mt-0.5"></i>
                            <span>設定為多日營隊後，系統將自動允許使用者在前端報名時勾選請假日期（規定超過3天將無法送出報名）。</span>
                        </div>
                        <div v-if="courseForm.type==='常態課後'" class="mt-3 text-xs text-purple-600 bg-purple-50 p-2 rounded flex items-start gap-2">
                            <i class="fas fa-info-circle mt-0.5"></i>
                            <span>常態課後為整學期固定每週上課之課程。</span>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-6 mb-6">
                        <div><label class="label-line">開始日期</label><input v-model="courseForm.startDate" type="date" class="input-line"></div>
                        <div><label class="label-line">結束日期</label><input v-model="courseForm.endDate" type="date" class="input-line"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-6 mb-6">
                        <div class="col-span-2"><label class="label-line">上課時段 (文字描述)</label><input v-model="courseForm.startTime" type="text" class="input-line" placeholder="例: 每天 09:00 - 16:00"></div>
                        <div><label class="label-line">上課地點</label><input v-model="courseForm.location" class="input-line" placeholder="例: 竹北國民運動中心 3F"></div>
                        <div><label class="label-line">指導教練</label><input v-model="courseForm.instructor" class="input-line" placeholder="教練名稱"></div>
                    </div>
                </div>

                <!-- 右側：費用與進階 -->
                <div class="w-1/2 p-8 overflow-y-auto bg-[#fafafa]">
                    <div class="text-sm font-bold text-gray-800 border-l-4 border-[#06C755] pl-2 mb-6">費用與圖文設定</div>
                    
                    <div class="grid grid-cols-3 gap-6 mb-6">
                        <div><label class="label-line text-green-600">標準定價 ($)</label><input v-model="courseForm.price" type="number" class="input-line font-bold text-lg text-[#06C755] border-green-300"></div>
                        <div><label class="label-line">報名總名額</label><input v-model="courseForm.capacity" type="number" class="input-line"></div>
                        <div><label class="label-line">總堂數 (計費基準)</label><input v-model="courseForm.totalSessions" type="number" class="input-line"></div>
                    </div>

                    <!-- 圖片與說明 (新增) -->
                    <div class="mb-4">
                        <label class="label-line">宣傳圖片網址 (URL)</label>
                        <input v-model="courseForm.image" class="input-line" placeholder="https://example.com/image.jpg">
                    </div>
                    <div class="mb-8">
                        <label class="label-line">課程詳細說明</label>
                        <textarea v-model="courseForm.description" rows="4" class="input-line resize-none" placeholder="請輸入課程內容介紹，將顯示於前端詳細資訊中..."></textarea>
                    </div>

                    <!-- 早鳥優惠 -->
                    <div class="bg-white border border-gray-200 rounded-lg p-5 mb-6 shadow-sm">
                        <div class="flex items-center justify-between mb-4">
                            <label class="font-bold text-gray-800 flex items-center text-sm"><i class="fas fa-stopwatch mr-2 text-orange-500"></i> 早鳥優惠設定</label>
                            <label class="toggle-switch">
                                <input type="checkbox" v-model="hasEarlyBird">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div v-if="hasEarlyBird" class="grid grid-cols-2 gap-6 bg-orange-50/50 p-4 rounded border border-orange-100">
                            <div><label class="label-line text-orange-700">早鳥優惠價 ($)</label><input v-model="courseForm.earlyBirdPrice" type="number" class="input-line border-orange-200"></div>
                            <div><label class="label-line text-orange-700">優惠截止日期</label><input v-model="courseForm.earlyBirdDate" type="date" class="input-line border-orange-200"></div>
                        </div>
                    </div>

                    <!-- 設備租用 -->
                    <div class="bg-white border border-gray-200 rounded-lg p-5 shadow-sm">
                        <div class="flex items-center justify-between mb-4">
                            <label class="font-bold text-gray-800 flex items-center text-sm"><i class="fas fa-tools mr-2 text-blue-500"></i> 加購 / 設備租用選項</label>
                            <button @click="addEquipment" class="text-xs font-bold bg-blue-50 text-blue-600 px-3 py-1.5 rounded hover:bg-blue-100 transition"><i class="fas fa-plus mr-1"></i>新增品項</button>
                        </div>
                        
                        <div v-if="equipList.length === 0" class="text-center text-gray-400 text-sm py-6 border-2 border-dashed border-gray-100 rounded">無設定加購項目</div>
                        
                        <div v-else class="space-y-3">
                            <div v-for="(eq, idx) in equipList" :key="idx" class="flex gap-3 items-center bg-gray-50 p-3 rounded-lg border border-gray-200">
                                <input v-model="eq.name" placeholder="輸入名稱 (如: 專用球拍)" class="input-line flex-1 bg-white">
                                <div class="relative w-32">
                                    <span class="absolute left-3 top-2.5 text-gray-400 font-bold">$</span>
                                    <input v-model="eq.price" type="number" placeholder="0" class="input-line pl-7 bg-white font-bold text-gray-700">
                                </div>
                                <button @click="removeEquipment(idx)" class="w-10 h-10 flex items-center justify-center rounded text-gray-400 hover:text-red-500 hover:bg-red-50 transition"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="h-20 px-8 border-t border-gray-200 bg-white flex items-center justify-end gap-4 shrink-0 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] z-10">
                <button @click="showCourseModal=false" class="btn-white px-8 py-2.5 text-base">取消</button>
                <button @click="submitCourse" class="btn-green px-8 py-2.5 text-base w-40">
                    <i class="fas fa-save"></i> 儲存設定
                </button>
            </div>
        </div>
    </div>
    </transition>

    <!-- 2. Member Modal -->
    <transition name="fade">
    <div v-if="showMemberModal" class="fixed inset-0 bg-black/60 z-[9999] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-5xl h-[85vh] rounded-xl shadow-2xl flex flex-col overflow-hidden">
            <div class="h-16 px-8 border-b border-gray-200 flex justify-between items-center bg-white shrink-0">
                <h3 class="text-xl font-bold text-gray-800 flex items-center"><i class="fas fa-user-edit text-[#06C755] mr-3"></i>會員詳細資料</h3>
                <button @click="showMemberModal=false" class="text-gray-400 hover:text-gray-600 p-2"><i class="fas fa-times text-2xl"></i></button>
            </div>
            <div class="flex-1 flex overflow-hidden">
                <div class="w-1/2 p-8 overflow-y-auto border-r border-gray-200 bg-white">
                    <div class="text-sm font-bold text-gray-800 border-l-4 border-[#06C755] pl-2 mb-6">主帳號資料</div>
                     <form @submit.prevent="saveMember" class="space-y-5">
                        <div class="grid grid-cols-2 gap-5">
                            <div><label class="label-line">姓名</label><input v-model="editingMember.name" class="input-line"></div>
                            <div><label class="label-line">身分證字號</label><input v-model="editingMember.nationalId" class="input-line bg-gray-50" readonly></div>
                        </div>
                        <div class="grid grid-cols-2 gap-5">
                            <div><label class="label-line">性別</label><select v-model="editingMember.gender" class="input-line"><option value="男">男</option><option value="女">女</option></select></div>
                            <div><label class="label-line">生日</label><input v-model="editingMember.birthday" type="date" class="input-line"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-5">
                            <div><label class="label-line">聯絡電話</label><input v-model="editingMember.phone" class="input-line"></div>
                            <div><label class="label-line">居住地址</label><input v-model="editingMember.address" class="input-line"></div>
                        </div>
                        <div><label class="label-line text-blue-600">健康備註 (對外顯示)</label><textarea v-model="editingMember.healthNote" rows="3" class="input-line resize-none"></textarea></div>
                        <div><label class="label-line text-yellow-600">管理備註 (內部專用)</label><textarea v-model="editingMember.notes" rows="3" class="input-line resize-none bg-yellow-50"></textarea></div>
                     </form>
                </div>
                <div class="w-1/2 p-8 overflow-y-auto bg-[#fafafa]">
                    <div class="text-sm font-bold text-gray-800 border-l-4 border-orange-500 pl-2 mb-6 flex justify-between items-center">
                        <span>家人名單 (共 {{ editingMember.familyMembers?.length || 0 }} 人)</span>
                    </div>
                    <div v-if="!editingMember.familyMembers || editingMember.familyMembers.length === 0" class="text-center text-gray-400 py-10 bg-white border border-dashed rounded">
                        此會員尚未綁定家人
                    </div>
                    <div v-else class="space-y-4">
                        <div v-for="fm in editingMember.familyMembers" :key="fm.userId" class="bg-white p-5 rounded-lg border border-gray-200 shadow-sm relative">
                            <span class="absolute top-4 right-4 text-xs font-bold bg-green-100 text-green-800 border border-green-200 px-2 py-1 rounded">{{ fm.relation }}</span>
                            <div class="font-bold text-lg text-gray-800 mb-3">{{ fm.name }}</div>
                            <div class="grid grid-cols-2 gap-2 text-sm text-gray-600">
                                <div><i class="fas fa-id-card w-5 text-gray-400"></i> {{ fm.nationalId }}</div>
                                <div><i class="fas fa-birthday-cake w-5 text-gray-400"></i> {{ formatDate(fm.birthday) }}</div>
                                <div><i class="fas fa-venus-mars w-5 text-gray-400"></i> {{ fm.gender || '未填' }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="h-20 px-8 border-t border-gray-200 bg-white flex items-center justify-end gap-4 shrink-0 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] z-10">
                <button @click="showMemberModal=false" class="btn-white px-8 py-2.5 text-base">取消</button>
                <button @click="saveMember" :disabled="isSaving" class="btn-green px-8 py-2.5 text-base w-40">
                    <i v-if="isSaving" class="fas fa-spinner fa-spin mr-2"></i> {{ isSaving ? '儲存中...' : '確認儲存' }}
                </button>
            </div>
        </div>
    </div>
    </transition>
    
    <!-- 3. Order Modal -->
    <transition name="fade">
    <div v-if="showOrderModal" class="fixed inset-0 bg-black/60 z-[9999] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-2xl max-h-[90vh] rounded-xl shadow-2xl flex flex-col overflow-hidden">
            <div class="h-16 px-6 border-b border-gray-200 flex justify-between items-center bg-white shrink-0">
                <h3 class="text-xl font-bold text-gray-800 flex items-center"><i class="fas fa-file-invoice text-[#06C755] mr-3"></i>編輯訂單資料</h3>
                <button @click="showOrderModal=false" class="text-gray-400 hover:text-gray-600 p-2"><i class="fas fa-times text-2xl"></i></button>
            </div>
            <div class="p-8 overflow-y-auto bg-[#fafafa] flex-1">
                 <div class="bg-white p-5 rounded border border-gray-200 mb-6 shadow-sm">
                     <div class="text-xs font-bold text-gray-400 mb-1">訂單編號</div>
                     <div class="font-mono text-gray-800 mb-4">{{ editingOrder.orderId }}</div>
                     <div class="grid grid-cols-2 gap-4 border-t pt-4">
                         <div><div class="text-xs text-gray-400">學員姓名</div><div class="font-bold">{{ editingOrder.name }}</div></div>
                         <div><div class="text-xs text-gray-400">聯絡電話</div><div class="font-bold">{{ editingOrder.phone }}</div></div>
                     </div>
                 </div>

                 <div class="grid grid-cols-2 gap-6 mb-6">
                     <div>
                         <label class="label-line">訂單狀態</label>
                         <select v-model="editingOrder.status" class="input-line">
                             <option value="PENDING">待付款 (PENDING)</option>
                             <option value="PAID">已付款 (PAID)</option>
                             <option value="CANCELLED">已取消 (CANCELLED)</option>
                         </select>
                     </div>
                     <div>
                         <label class="label-line">總金額</label>
                         <input v-model="editingOrder.amount" type="number" class="input-line font-bold text-[#06C755] text-lg">
                     </div>
                 </div>
                 <div class="mb-6">
                     <label class="label-line">匯款帳號後五碼</label>
                     <input v-model="editingOrder.remittance" class="input-line font-mono tracking-widest text-lg" placeholder="未填寫">
                 </div>
                 <div>
                     <label class="label-line">管理員備註</label>
                     <textarea v-model="editingOrder.note" rows="3" class="input-line resize-none" placeholder="輸入內部備註..."></textarea>
                 </div>
            </div>
            <div class="h-20 px-8 border-t border-gray-200 bg-white flex items-center justify-end gap-4 shrink-0 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] z-10">
                <button @click="showOrderModal=false" class="btn-white px-8 py-2.5 text-base">取消</button>
                <button @click="saveOrder" class="btn-green px-8 py-2.5 text-base w-40 justify-center"><i class="fas fa-save"></i> 儲存變更</button>
            </div>
        </div>
    </div>
    </transition>

</div>

<script>
    const { createApp, ref, computed, watch } = Vue;
    const API_ENDPOINT = 'https://sport-island.fangwl591021.workers.dev/'; 

    createApp({
        setup() {
            const isLoggedIn=ref(false), password=ref(''), isLoading=ref(false), isSaving=ref(false), currentTab=ref('courses'), error=ref('');
            const courses=ref([]), orders=ref([]), users=ref([]);
            const showCourseModal=ref(false), isEditingCourse=ref(false), showMemberModal=ref(false), showOrderModal=ref(false);
            const editingMember=ref({}), editingOrder=ref({});
            const searchTerm=ref(''), filterStatus=ref('');

            const courseForm = ref({
                id:'', name:'', startDate:'', endDate:'', startTime:'', price:0, capacity:0, totalSessions:1, location:'', instructor:'',
                type: '單日課程', timeSlotType: '全日', earlyBirdPrice: 0, earlyBirdDate: '', equipmentJson: '[]',
                image: '', description: ''
            });
            const hasEarlyBird = ref(false);
            const equipList = ref([]);

            // Unpaid Modal Refs
            const showUnpaidModal = ref(false);
            const unpaidList = ref([]);
            const unpaidCourseName = ref('');

            watch(hasEarlyBird, (val) => { if(!val) { courseForm.value.earlyBirdPrice=0; courseForm.value.earlyBirdDate=''; } });
            
            const tabName = computed(() => ({'courses':'課程管理','orders':'訂單管理','members':'會員管理'}[currentTab.value]));
            const filteredOrders = computed(() => orders.value.filter(o => (o.name+o.phone+o.orderId).includes(searchTerm.value) && (!filterStatus.value || o.status === filterStatus.value)));
            const filteredUsers = computed(() => users.value.filter(u => (u.name+u.nationalId).includes(searchTerm.value)));
            const totalEnrolled = computed(() => courses.value.reduce((acc, c) => acc + c.enrolled, 0));
            const pendingCount = computed(() => orders.value.filter(o => o.status === 'PENDING').length);

            const callApi = async (action, payload={}) => {
                const res = await fetch(API_ENDPOINT, { method:'POST', body:JSON.stringify({action, payload:{password:password.value, ...payload}}) });
                const json = await res.json();
                if(json.status!=='success') throw new Error(json.message);
                return json.data;
            };

            const login = async () => { isLoading.value=true; try { await callApi('ADMIN_LOGIN'); isLoggedIn.value=true; fetchData(); } catch(e){ error.value='密碼錯誤'; } finally { isLoading.value=false; } };
            const logout = () => { isLoggedIn.value=false; password.value=''; };
            const fetchData = async () => { 
                isLoading.value=true; 
                try { const d = await callApi('ADMIN_GET_DATA'); courses.value=d.courses; orders.value=d.orders.reverse(); users.value=d.users.reverse(); } catch(e){ alert('Error'); } 
                isLoading.value=false; 
            };

            // 安全擷取 YYYY-MM-DD，避開時區影響
            const fmtDateForInput = d => {
                if (!d) return '';
                if (typeof d === 'string' && d.length >= 10) return d.substring(0, 10);
                return d;
            };

            const openAddCourse = () => { 
                isEditingCourse.value=false; 
                courseForm.value={id:'',name:'',startDate:'',endDate:'',startTime:'',price:0,capacity:0,totalSessions:1,location:'',instructor:'', type:'單日課程', timeSlotType:'全日', earlyBirdPrice:0, earlyBirdDate:'', equipmentJson:'[]', image:'', description:''}; 
                hasEarlyBird.value=false; equipList.value=[];
                showCourseModal.value=true; 
            };
            
            const openEditCourse = (c) => { 
                isEditingCourse.value=true;
                courseForm.value = {...c, startDate: fmtDateForInput(c.startDate), endDate: fmtDateForInput(c.endDate), earlyBirdDate: fmtDateForInput(c.earlyBirdDate)};
                hasEarlyBird.value = c.earlyBirdPrice > 0;
                try { equipList.value = JSON.parse(c.equipmentJson || '[]'); } catch(e) { equipList.value=[]; }
                showCourseModal.value=true; 
            };

            const copyCourse = (c) => {
                isEditingCourse.value = false; // 複製視同新增課程
                // 帶入被複製的課程資料，但清空代碼強迫重填，並在名稱後方加上標示
                courseForm.value = {
                    ...c, 
                    id: '', 
                    name: c.name + ' (複製)', 
                    startDate: fmtDateForInput(c.startDate), 
                    endDate: fmtDateForInput(c.endDate), 
                    earlyBirdDate: fmtDateForInput(c.earlyBirdDate)
                };
                hasEarlyBird.value = c.earlyBirdPrice > 0;
                try { equipList.value = JSON.parse(c.equipmentJson || '[]'); } catch(e) { equipList.value=[]; }
                showCourseModal.value = true;
            };

            const addEquipment = () => equipList.value.push({name:'', price:0});
            const removeEquipment = (i) => equipList.value.splice(i,1);

            const submitCourse = async () => {
                courseForm.value.equipmentJson = JSON.stringify(equipList.value);
                const action = isEditingCourse.value ? 'ADMIN_UPDATE_COURSE' : 'ADMIN_ADD_COURSE';
                try { await callApi(action, courseForm.value); alert('成功'); showCourseModal.value=false; fetchData(); } catch(e){ alert('失敗'); }
            };

            const openMember = (u) => { 
                try {
                    let copy = JSON.parse(JSON.stringify(u));
                    copy.birthday = fmtDateForInput(copy.birthday);
                    if(!copy.familyMembers) copy.familyMembers=[];
                    editingMember.value = copy; showMemberModal.value=true; 
                } catch(e){}
            };
            const saveMember = async () => {
                if(!confirm('確認儲存?')) return;
                isSaving.value = true;
                try { await callApi('ADMIN_UPDATE_MEMBER', {memberData:editingMember.value}); alert('已儲存'); showMemberModal.value=false; fetchData(); } catch(e){ alert('失敗'); } finally { isSaving.value = false; }
            };

            const openOrder = (o) => { editingOrder.value={...o}; showOrderModal.value=true; };
            const saveOrder = async () => { await callApi('ADMIN_UPDATE_ORDER', {orderData:editingOrder.value}); showOrderModal.value=false; fetchData(); };

            // Unpaid logic
            const getUnpaidCount = (courseId) => {
                return orders.value.filter(o => o.courseId === courseId && o.status === 'PENDING').length;
            };
            
            const openUnpaidModal = (course) => {
                const list = orders.value.filter(o => o.courseId === course.id && o.status === 'PENDING');
                if (list.length === 0) return;
                unpaidList.value = list;
                unpaidCourseName.value = course.name;
                showUnpaidModal.value = true;
            };

            const formatDate = d => d ? new Date(d).toLocaleDateString('zh-TW') : '-';
            const formatTime = d => d ? new Date(d).toLocaleString('zh-TW',{hour12:false}) : '-';
            const getStatusLabel = s => ({'PENDING':'待付','PAID':'已付','CANCELLED':'取消'}[s]||s);
            const getStatusClass = s => ({'PENDING':'bg-yellow-100 text-yellow-800 border border-yellow-200','PAID':'bg-green-100 text-green-800 border border-green-200','CANCELLED':'bg-gray-100 text-gray-500 border border-gray-200'}[s]);

            return { 
                isLoggedIn, password, isLoading, isSaving, error, currentTab, tabName, courses, orders, users, totalEnrolled, pendingCount,
                filteredOrders, filteredUsers, searchTerm, filterStatus,
                showCourseModal, isEditingCourse, courseForm, hasEarlyBird, equipList,
                showMemberModal, editingMember, showOrderModal, editingOrder,
                showUnpaidModal, unpaidList, unpaidCourseName, getUnpaidCount, openUnpaidModal,
                login, logout, fetchData, openAddCourse, openEditCourse, copyCourse, submitCourse, addEquipment, removeEquipment,
                openMember, saveMember, openOrder, saveOrder,
                formatDate, formatTime, getStatusLabel, getStatusClass
            };
        }
    }).mount('#app');
</script>
</body>
</html>
