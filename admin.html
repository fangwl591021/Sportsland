<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>運動島管理後台</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        [v-cloak] { display: none; }
        
        :root { --line-green: #06C755; --bg-body: #f5f6f8; --text-main: #1e1e2d; }

        body { font-family: -apple-system, BlinkMacSystemFont, Arial, sans-serif; background: var(--bg-body); color: var(--text-main); overflow: hidden; }

        /* Sidebar */
        .sidebar { @apply w-64 bg-white border-r border-gray-200 flex flex-col shrink-0 h-full z-20; }
        .sidebar-item { @apply flex items-center px-6 py-4 text-gray-500 cursor-pointer transition-all duration-200 border-l-4 border-transparent text-sm font-medium hover:bg-[#f0f9f3] hover:text-[#06C755]; }
        .sidebar-item.active { @apply bg-[#f0f9f3] text-[#06C755] border-[#06C755] font-bold; }

        /* Buttons */
        .btn-primary { @apply bg-[#06C755] hover:bg-[#05b34c] text-white px-5 py-2.5 rounded shadow-sm text-sm font-bold transition flex items-center justify-center gap-2 disabled:bg-gray-400 disabled:cursor-not-allowed; }
        .btn-outline { @apply border border-gray-300 bg-white text-gray-600 hover:bg-gray-50 px-4 py-2.5 rounded text-sm transition; }
        .btn-icon { @apply w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 transition text-gray-400 hover:text-gray-600; }

        /* Forms */
        .form-label { @apply block text-xs font-bold text-gray-500 mb-1.5 ml-1 uppercase; }
        .form-input { @apply w-full border border-gray-300 bg-white px-3 py-2.5 rounded-md text-sm focus:border-[#06C755] focus:ring-1 focus:ring-[#06C755] outline-none transition-all; }
        .form-input:read-only { @apply bg-gray-100 text-gray-400 cursor-not-allowed; }

        /* Table */
        .data-table th { @apply px-6 py-3 text-left text-xs font-bold text-gray-500 bg-gray-50 border-b border-gray-200; }
        .data-table td { @apply px-6 py-4 text-sm border-b border-gray-100 align-middle; }

        /* Modals */
        .modal-mask { @apply fixed inset-0 bg-black/60 backdrop-blur-[2px] z-[9999] flex items-center justify-center; }
        .modal-pop { @apply bg-white w-[98%] h-[98%] max-w-[1600px] rounded-lg shadow-2xl flex flex-col overflow-hidden relative; animation: popIn 0.2s ease-out; }
        @keyframes popIn { 0% { opacity: 0; transform: scale(0.95); } 100% { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body>

<div id="app" v-cloak class="h-full flex flex-col">

    <!-- Login -->
    <div v-if="!isLoggedIn" class="fixed inset-0 z-[1000] flex items-center justify-center bg-[#f0f2f5]">
        <div class="bg-white p-10 rounded-xl shadow-xl w-[400px] border border-gray-200 text-center">
            <h1 class="text-xl font-bold text-gray-800 mb-8">運動島管理後台</h1>
            <form @submit.prevent="login">
                <input v-model="password" type="password" class="form-input mb-4" placeholder="管理密碼">
                <button :disabled="isLoading" class="w-full btn-primary py-3">{{ isLoading ? '登入中...' : '登入' }}</button>
            </form>
        </div>
    </div>

    <!-- Main -->
    <div v-else class="flex h-full w-full">
        <aside class="sidebar">
            <div class="h-16 flex items-center px-6 border-b border-gray-200"><span class="bg-[#06C755] text-white px-2 py-0.5 rounded text-xs font-bold mr-2">LINE OA</span><span class="font-bold text-gray-800 tracking-wide text-lg">運動島管理</span></div>
            <nav class="flex-col py-4 overflow-y-auto flex-1 flex">
                <div class="px-6 mb-2 mt-2 text-xs font-bold text-gray-400 uppercase tracking-widest">MENU</div>
                <a @click="currentTab='courses'" :class="{'active':currentTab==='courses'}" class="sidebar-item"><i class="fas fa-chalkboard-teacher w-6 text-center mr-3"></i> 課程管理</a>
                <a @click="currentTab='orders'" :class="{'active':currentTab==='orders'}" class="sidebar-item"><i class="fas fa-file-invoice-dollar w-6 text-center mr-3"></i> 訂單管理</a>
                <a @click="currentTab='members'" :class="{'active':currentTab==='members'}" class="sidebar-item"><i class="fas fa-users w-6 text-center mr-3"></i> 會員管理</a>
            </nav>
            <div class="p-4 border-t border-gray-200 bg-gray-50/50 shrink-0 text-center"><button @click="logout" class="text-xs text-gray-500 hover:text-red-500">登出系統</button></div>
        </aside>

        <main class="main-area">
            <header class="h-16 bg-white border-b border-gray-200 flex justify-between items-center px-8 shadow-sm shrink-0">
                <h2 class="text-xl font-bold text-gray-800 pl-3 border-l-4 border-[#06C755]">{{ tabName }}</h2>
                <button @click="fetchData" class="btn-outline py-1.5"><i class="fas fa-sync-alt" :class="{'fa-spin':isLoading}"></i> 資料同步</button>
            </header>

            <div class="content-scroll">
                <!-- Courses -->
                <div v-if="currentTab==='courses'">
                    <div class="flex justify-between items-end mb-6">
                        <div class="text-2xl font-bold text-gray-800">上架課程：{{ courses.length }}</div>
                        <button @click="openAddCourse" class="btn-primary"><i class="fas fa-plus"></i> 新增課程</button>
                    </div>
                    <div class="bg-white border border-gray-200 rounded shadow-sm overflow-hidden">
                        <table class="data-table">
                            <thead><tr><th>課程資訊</th><th>類型/時間</th><th>費用/名額</th><th>操作</th></tr></thead>
                            <tbody>
                                <tr v-for="c in courses" :key="c.id">
                                    <td class="w-1/3"><div class="font-bold text-gray-800">{{ c.name }}</div><div class="text-xs text-gray-400 font-mono mt-1">{{ c.id }}</div></td>
                                    <td>
                                        <div class="flex gap-2 mb-1"><span class="text-xs bg-blue-100 text-blue-700 px-2 rounded">{{ c.type }}</span></div>
                                        <div class="text-sm text-gray-600">{{ formatDate(c.startDate) }} ~ {{ formatDate(c.endDate) }}</div>
                                    </td>
                                    <td><div class="text-[#06C755] font-bold">${{ c.price }}</div><div class="text-xs text-gray-500">{{ c.enrolled }} / {{ c.capacity }} 人</div></td>
                                    <td class="text-right"><button @click="openEditCourse(c)" class="btn-icon"><i class="fas fa-pen"></i></button></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Orders (略, 同前) -->
                <div v-if="currentTab==='orders'">
                    <div class="bg-white border rounded overflow-hidden">
                        <table class="data-table">
                            <thead><tr><th>訂單</th><th>學員</th><th>金額</th><th>狀態</th><th>操作</th></tr></thead>
                            <tbody>
                                <tr v-for="o in filteredOrders" :key="o.orderId">
                                    <td>{{ o.orderId.slice(0,8) }}<br><span class="text-xs text-gray-400">{{ formatTime(o.createdAt) }}</span></td>
                                    <td>{{ o.name }}<br><span class="text-xs text-gray-400">{{ o.phone }}</span></td>
                                    <td class="font-bold text-[#06C755]">${{ o.amount }}</td>
                                    <td><span class="text-xs px-2 py-1 rounded font-bold" :class="getStatusClass(o.status)">{{ getStatusLabel(o.status) }}</span></td>
                                    <td class="text-right"><button @click="openOrder(o)" class="btn-outline py-1 px-3 text-xs">編輯</button></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Members (略, 同前) -->
                <div v-if="currentTab==='members'">
                    <div class="bg-white p-4 rounded border border-gray-200 mb-6"><input v-model="searchTerm" placeholder="搜尋會員..." class="form-input pl-4 border-gray-200 shadow-none"></div>
                    <div class="bg-white border rounded overflow-hidden">
                        <table class="data-table">
                            <thead><tr><th>姓名</th><th>身分證</th><th>家人</th><th>操作</th></tr></thead>
                            <tbody>
                                <tr v-for="u in filteredUsers" :key="u.userId">
                                    <td class="font-bold">{{ u.name }}</td><td>{{ u.nationalId }}</td><td>{{ u.familyMembers?.length||0 }}</td>
                                    <td class="text-right"><button @click="openMember(u)" class="text-[#06C755] text-sm font-bold">詳情</button></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->

    <!-- Member Modal (新增性別與儲存狀態) -->
    <div v-if="showMemberModal" class="modal-mask">
        <div class="modal-pop">
            <div class="h-16 px-8 border-b border-gray-100 flex justify-between items-center bg-white shrink-0">
                <h3 class="text-lg font-bold text-gray-800">會員資料</h3><button @click="showMemberModal=false" class="btn-icon"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="flex-1 flex overflow-hidden">
                <div class="w-1/2 p-8 overflow-y-auto border-r border-gray-100 bg-white">
                     <form @submit.prevent="saveMember" class="space-y-4">
                        <div class="grid grid-cols-2 gap-4"><div><label class="form-label">姓名</label><input v-model="editingMember.name" class="form-input"></div><div><label class="form-label">身分證</label><input v-model="editingMember.nationalId" class="form-input bg-gray-50" readonly></div></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="form-label">性別</label><select v-model="editingMember.gender" class="form-input"><option value="">請選擇</option><option value="男">男</option><option value="女">女</option></select></div>
                            <div><label class="form-label">生日</label><input v-model="editingMember.birthday" type="date" class="form-input"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-4"><div><label class="form-label">電話</label><input v-model="editingMember.phone" class="form-input"></div><div><label class="form-label">地址</label><input v-model="editingMember.address" class="form-input"></div></div>
                        <div><label class="form-label text-blue-600">健康備註</label><textarea v-model="editingMember.healthNote" rows="3" class="form-input"></textarea></div>
                        <div><label class="form-label text-yellow-600">管理備註</label><textarea v-model="editingMember.notes" rows="3" class="form-input bg-yellow-50"></textarea></div>
                     </form>
                </div>
                <div class="w-1/2 p-8 overflow-y-auto bg-[#fafafa]">
                    <h4 class="text-xs font-bold text-gray-400 mb-4">家人名單</h4>
                    <div v-for="fm in editingMember.familyMembers" :key="fm.userId" class="bg-white p-3 rounded border border-gray-200 mb-2 shadow-sm">
                        <div class="font-bold">{{ fm.name }} <span class="text-xs bg-gray-100 px-2 rounded">{{ fm.relation }}</span></div>
                        <div class="text-xs text-gray-500">ID: {{ fm.nationalId }} | 性別: {{ fm.gender }}</div>
                    </div>
                </div>
            </div>
            <div class="h-20 px-8 border-t border-gray-100 bg-white flex items-center justify-end gap-3 shrink-0">
                <button @click="showMemberModal=false" class="btn-outline">取消</button>
                <button @click="saveMember" :disabled="isSaving" class="btn-primary w-32 justify-center">
                    <i v-if="isSaving" class="fas fa-spinner fa-spin"></i> {{ isSaving ? '儲存中...' : '儲存' }}
                </button>
            </div>
        </div>
    </div>
    
    <!-- Course & Order Modals (Keep as previously defined, simplified here for brevity) -->
    <div v-if="showCourseModal" class="modal-mask"><div class="modal-pop"> <!-- Copy Course Modal Logic Here --> <div class="p-8"><button @click="showCourseModal=false" class="btn-outline">關閉 (請複製完整 Modal 代碼)</button></div></div></div>
    <div v-if="showOrderModal" class="modal-mask"><div class="modal-pop !max-w-[600px] !h-auto !max-h-[90%]"><div class="p-8">編輯訂單 (請複製完整 Modal 代碼) <button @click="showOrderModal=false" class="btn-outline mt-4">關閉</button></div></div></div>

</div>

<script>
    const { createApp, ref, computed, watch } = Vue;
    const API_ENDPOINT = 'https://sport-island.fangwl591021.workers.dev/'; 

    createApp({
        setup() {
            const isLoggedIn=ref(false), password=ref(''), isLoading=ref(false), isSaving=ref(false), currentTab=ref('courses'), error=ref('');
            const courses=ref([]), orders=ref([]), users=ref([]);
            const showCourseModal=ref(false), isEditingCourse=ref(false), showMemberModal=ref(false), showOrderModal=ref(false);
            const editingMember=ref({}), editingOrder=ref({});
            const searchTerm=ref(''), filterStatus=ref('');
            const courseForm = ref({id:'', name:'', startDate:'', endDate:'', startTime:'', price:0, capacity:0, totalSessions:1, location:'', instructor:'', type: '單日課程', timeSlotType: '全日', earlyBirdPrice: 0, earlyBirdDate: '', equipmentJson: '[]'});
            const hasEarlyBird = ref(false), equipList = ref([]);
            watch(hasEarlyBird, (val) => { if(!val) { courseForm.value.earlyBirdPrice=0; courseForm.value.earlyBirdDate=''; } });
            
            const tabName = computed(() => ({'courses':'課程管理','orders':'訂單管理','members':'會員管理'}[currentTab.value]));
            const filteredOrders = computed(() => orders.value.filter(o => (o.name+o.phone).includes(searchTerm.value)));
            const filteredUsers = computed(() => users.value.filter(u => (u.name+u.nationalId).includes(searchTerm.value)));
            const totalEnrolled = computed(() => courses.value.reduce((acc, c) => acc + c.enrolled, 0));
            const pendingCount = computed(() => orders.value.filter(o => o.status === 'PENDING').length);

            const callApi = async (action, payload={}) => {
                const res = await fetch(API_ENDPOINT, { method:'POST', body:JSON.stringify({action, payload:{password:password.value, ...payload}}) });
                const json = await res.json();
                if(json.status!=='success') throw new Error(json.message);
                return json.data;
            };

            const login = async () => { isLoading.value=true; try { await callApi('ADMIN_LOGIN'); isLoggedIn.value=true; fetchData(); } catch(e){ error.value='密碼錯誤'; } finally { isLoading.value=false; } };
            const logout = () => { isLoggedIn.value=false; password.value=''; };
            const fetchData = async () => { 
                isLoading.value=true; 
                try { const d = await callApi('ADMIN_GET_DATA'); courses.value=d.courses; orders.value=d.orders.reverse(); users.value=d.users.reverse(); } catch(e){ alert('Error'); } 
                isLoading.value=false; 
            };

            const openAddCourse = () => { isEditingCourse.value=false; courseForm.value={id:'',name:'',startDate:'',endDate:'',startTime:'',price:0,capacity:0,totalSessions:1,location:'',instructor:'', type:'單日課程', timeSlotType:'全日', earlyBirdPrice:0, earlyBirdDate:'', equipmentJson:'[]'}; hasEarlyBird.value=false; equipList.value=[]; showCourseModal.value=true; };
            const openEditCourse = (c) => { isEditingCourse.value=true; courseForm.value = {...c}; showCourseModal.value=true; };
            const submitCourse = async () => { try { await callApi(isEditingCourse.value?'ADMIN_UPDATE_COURSE':'ADMIN_ADD_COURSE', courseForm.value); alert('成功'); showCourseModal.value=false; fetchData(); } catch(e){ alert('失敗'); } };

            const openMember = (u) => { editingMember.value=JSON.parse(JSON.stringify(u)); showMemberModal.value=true; };
            
            const saveMember = async () => {
                if(!confirm('確認儲存?')) return;
                isSaving.value = true;
                try { 
                    await callApi('ADMIN_UPDATE_MEMBER', {memberData:editingMember.value}); 
                    alert('已儲存'); 
                    showMemberModal.value=false; 
                    fetchData(); 
                } catch(e){ alert('失敗: '+e.message); } 
                finally { isSaving.value = false; }
            };

            const openOrder = (o) => { editingOrder.value={...o}; showOrderModal.value=true; };
            const saveOrder = async () => { await callApi('ADMIN_UPDATE_ORDER', {orderData:editingOrder.value}); showOrderModal.value=false; fetchData(); };

            const formatDate = d => d ? new Date(d).toLocaleDateString('zh-TW') : '-';
            const formatTime = d => d ? new Date(d).toLocaleString('zh-TW',{hour12:false}) : '-';
            const getStatusLabel = s => ({'PENDING':'待付','PAID':'已付','CANCELLED':'取消'}[s]||s);
            const getStatusClass = s => ({'PENDING':'bg-yellow-100 text-yellow-800','PAID':'bg-green-100 text-green-800','CANCELLED':'bg-gray-100'}[s]);

            return { 
                isLoggedIn, password, isLoading, isSaving, error, currentTab, tabName, courses, orders, users, totalEnrolled, pendingCount,
                filteredOrders, filteredUsers, searchTerm, filterStatus,
                showCourseModal, isEditingCourse, courseForm, hasEarlyBird, equipList,
                showMemberModal, editingMember, showOrderModal, editingOrder,
                login, logout, fetchData, openAddCourse, openEditCourse, submitCourse,
                openMember, saveMember, openOrder, saveOrder,
                formatDate, formatTime, getStatusLabel, getStatusClass
            };
        }
    }).mount('#app');
</script>
</body>
</html>
