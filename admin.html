<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>運動島綜合運動體能館 - 管理後台</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        [v-cloak] { display: none; }
        
        /* LINE OA & CRM 風格色票 */
        :root {
            --line-green: #06C755;
            --bg-body: #f5f6f8;
            --text-main: #333;
            --text-sub: #888;
            --border-color: #e5e7eb;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
            background-color: var(--bg-body); 
            color: var(--text-main);
            overflow: hidden; /* 防止 Body 捲動 */
        }

        /* 側邊欄 */
        .sidebar-item {
            @apply flex items-center px-6 py-4 text-gray-500 cursor-pointer transition-all duration-200 border-l-4 border-transparent text-sm font-medium hover:bg-gray-50;
        }
        .sidebar-item.active {
            @apply bg-[#f0f9f3] text-[#06C755] border-[#06C755] font-bold;
        }

        /* 按鈕 */
        .btn-primary { 
            @apply bg-[#06C755] hover:bg-[#05b34c] text-white px-5 py-2.5 rounded-lg shadow-sm text-sm font-bold transition duration-150 flex items-center justify-center gap-2; 
        }
        .btn-outline { 
            @apply border border-gray-300 bg-white text-gray-600 hover:bg-gray-50 px-4 py-2.5 rounded-lg text-sm transition duration-150; 
        }
        .btn-icon { @apply p-2 rounded-full hover:bg-gray-100 text-gray-500 transition; }

        /* 表單元件 (Ragic/CRM 風格) */
        .form-group { @apply mb-6; }
        .form-label { @apply block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2 ml-1; }
        .form-input { 
            @apply w-full border border-gray-300 bg-white px-4 py-3 rounded-lg text-sm text-gray-800 shadow-sm
            focus:border-[#06C755] focus:ring-4 focus:ring-[#06C755]/10 outline-none transition-all; 
        }
        .form-input:read-only { @apply bg-gray-100 text-gray-500 cursor-not-allowed border-gray-200 shadow-none; }
        .form-textarea { @apply form-input resize-none leading-relaxed; }

        /* 表格 */
        .data-table th { @apply px-6 py-4 text-left text-xs font-bold text-gray-500 uppercase bg-gray-50 border-b border-gray-200; }
        .data-table td { @apply px-6 py-4 text-sm border-b border-gray-100 align-middle; }
        .data-table tr:hover { @apply bg-[#fcfcfc]; }

        /* Drawer (抽屜式視窗) */
        .drawer-overlay { @apply fixed inset-0 bg-black/40 backdrop-blur-[2px] z-[100] transition-opacity duration-300; }
        .drawer-content { 
            @apply fixed top-0 right-0 h-full w-[800px] max-w-[90vw] bg-white shadow-2xl z-[101] flex flex-col transform transition-transform duration-300 border-l border-gray-200;
        }
        .drawer-enter-from .drawer-content { @apply translate-x-full; }
        .drawer-leave-to .drawer-content { @apply translate-x-full; }
        .drawer-enter-from.drawer-overlay, .drawer-leave-to.drawer-overlay { @apply opacity-0; }

        /* 狀態標籤 */
        .status-pill { @apply px-3 py-1 rounded-full text-xs font-bold inline-flex items-center gap-1.5; }
    </style>
</head>
<body>

<div id="app" v-cloak class="h-full flex flex-col">

    <!-- Login -->
    <div v-if="!isLoggedIn" class="fixed inset-0 z-[200] flex items-center justify-center bg-[#f5f6f8]">
        <div class="bg-white p-10 rounded-2xl shadow-xl w-[400px] border border-gray-200 text-center">
            <div class="w-16 h-16 bg-[#06C755] rounded-2xl flex items-center justify-center mx-auto mb-6 text-white text-3xl shadow-lg shadow-green-200">
                <i class="fas fa-running"></i>
            </div>
            <h1 class="text-2xl font-bold text-gray-800 mb-2">運動島管理後台</h1>
            <p class="text-gray-400 text-sm mb-8">請輸入管理員密碼</p>
            <form @submit.prevent="login">
                <div class="form-group text-left">
                    <label class="form-label">Password</label>
                    <input v-model="password" type="password" class="form-input" placeholder="••••••••">
                </div>
                <button :disabled="isLoading" class="w-full btn-primary py-3 text-base shadow-lg shadow-green-200/50">
                    <i v-if="isLoading" class="fas fa-circle-notch fa-spin"></i> {{ isLoading ? '登入中...' : '登入系統' }}
                </button>
                <p v-if="error" class="text-red-500 text-sm mt-4 bg-red-50 py-2 rounded">{{ error }}</p>
            </form>
        </div>
    </div>

    <!-- Main Layout -->
    <div v-else class="flex h-full">
        
        <!-- Sidebar -->
        <aside class="w-64 bg-white border-r border-gray-200 flex flex-col z-20 shadow-[4px_0_24px_rgba(0,0,0,0.02)]">
            <div class="h-16 flex items-center px-6 border-b border-gray-100">
                <span class="text-[#06C755] text-2xl mr-2"><i class="fas fa-dumbbell"></i></span>
                <span class="font-bold text-lg tracking-tight text-gray-800">運動島管理</span>
            </div>
            
            <nav class="flex-1 py-6 space-y-1 overflow-y-auto">
                <div class="px-6 mb-3 text-xs font-bold text-gray-400 uppercase tracking-widest">MENU</div>
                <a @click="currentTab='courses'" :class="{'active':currentTab==='courses'}" class="sidebar-item">
                    <i class="fas fa-chalkboard-teacher w-5 text-center mr-3"></i> 課程管理
                </a>
                <a @click="currentTab='orders'" :class="{'active':currentTab==='orders'}" class="sidebar-item">
                    <i class="fas fa-file-invoice-dollar w-5 text-center mr-3"></i> 訂單管理
                </a>
                <a @click="currentTab='members'" :class="{'active':currentTab==='members'}" class="sidebar-item">
                    <i class="fas fa-users w-5 text-center mr-3"></i> 會員管理
                </a>
            </nav>

            <div class="p-4 border-t border-gray-100 bg-gray-50/50">
                <div class="flex items-center gap-3 mb-3">
                    <div class="w-8 h-8 rounded-full bg-[#06C755] text-white flex items-center justify-center font-bold text-xs">A</div>
                    <div>
                        <div class="text-sm font-bold text-gray-700">系統管理員</div>
                        <div class="text-xs text-gray-400">Admin</div>
                    </div>
                </div>
                <button @click="logout" class="w-full btn-outline py-1.5 text-xs">登出</button>
            </div>
        </aside>

        <!-- Content -->
        <main class="flex-1 flex flex-col min-w-0 bg-[#f8f9fa] relative z-0">
            <!-- Topbar -->
            <header class="h-16 bg-white border-b border-gray-200 flex justify-between items-center px-8 shadow-sm sticky top-0 z-10">
                <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <span class="w-1 h-6 bg-[#06C755] rounded-full inline-block"></span>
                    {{ tabName }}
                </h2>
                <button @click="fetchData" class="text-gray-500 hover:text-[#06C755] transition flex items-center gap-2 text-sm font-medium bg-gray-50 px-3 py-1.5 rounded-lg hover:bg-green-50">
                    <i class="fas fa-sync-alt" :class="{'fa-spin':isLoading}"></i> 資料同步
                </button>
            </header>

            <!-- Scrollable Page -->
            <div class="flex-1 overflow-auto p-8">
                
                <!-- Courses Table -->
                <div v-if="currentTab==='courses'">
                    <div class="flex justify-between items-end mb-6">
                        <div class="flex gap-4">
                            <div class="bg-white px-5 py-3 rounded-xl border border-gray-200 shadow-sm">
                                <div class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">上架課程</div>
                                <div class="text-2xl font-bold text-gray-800 mt-1">{{ courses.length }}</div>
                            </div>
                            <div class="bg-white px-5 py-3 rounded-xl border border-gray-200 shadow-sm">
                                <div class="text-[10px] text-gray-400 font-bold uppercase tracking-wider">總報名</div>
                                <div class="text-2xl font-bold text-[#06C755] mt-1">{{ totalEnrolled }}</div>
                            </div>
                        </div>
                        <button @click="openAddCourse" class="btn-primary"><i class="fas fa-plus"></i> 新增課程</button>
                    </div>

                    <div class="bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden">
                        <table class="w-full data-table">
                            <thead><tr><th>課程名稱 / 代碼</th><th>日期時間</th><th>教練 / 費用</th><th>報名進度</th><th class="text-right">操作</th></tr></thead>
                            <tbody>
                                <tr v-for="c in courses" :key="c.id" class="group">
                                    <td class="w-1/3">
                                        <div class="font-bold text-gray-800 text-base mb-1">{{ c.name }}</div>
                                        <div class="flex items-center gap-2">
                                            <span class="bg-gray-100 text-gray-500 text-xs px-2 py-0.5 rounded font-mono">{{ c.id }}</span>
                                            <span class="text-xs text-gray-400 flex items-center"><i class="fas fa-map-marker-alt mr-1"></i> {{ c.location || '未定' }}</span>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="text-sm font-medium text-gray-700 mb-1">{{ formatDate(c.startDate) }} ~ {{ formatDate(c.endDate) }}</div>
                                        <div class="text-xs text-gray-500" v-if="c.startTime"><i class="far fa-clock mr-1"></i> {{ c.startTime }}</div>
                                    </td>
                                    <td>
                                        <div class="flex items-center gap-2 mb-1">
                                            <span class="text-sm text-gray-700">{{ c.instructor || '未定' }}</span>
                                            <span class="text-[10px] bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded">共{{ c.totalSessions }}堂</span>
                                        </div>
                                        <div class="text-[#06C755] font-bold">${{ c.price }}</div>
                                    </td>
                                    <td class="w-48">
                                        <div class="flex justify-between text-xs text-gray-500 mb-1.5">
                                            <span>{{ c.enrolled }} / {{ c.capacity }}</span>
                                            <span class="font-bold">{{ Math.round((c.enrolled/c.capacity)*100) }}%</span>
                                        </div>
                                        <div class="w-full bg-gray-100 rounded-full h-2 overflow-hidden">
                                            <div class="bg-[#06C755] h-2 rounded-full" :style="{width: Math.min((c.enrolled/c.capacity)*100, 100) + '%'}"></div>
                                        </div>
                                    </td>
                                    <td class="text-right">
                                        <button @click="openEditCourse(c)" class="btn-icon"><i class="fas fa-pen"></i></button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Orders Table -->
                <div v-if="currentTab==='orders'">
                    <div class="bg-white p-4 rounded-xl border border-gray-200 flex gap-4 shadow-sm mb-6">
                        <div class="relative flex-grow max-w-lg">
                            <i class="fas fa-search absolute left-3 top-3.5 text-gray-400"></i>
                            <input v-model="searchTerm" placeholder="搜尋訂單 (姓名、電話...)" class="form-input pl-10 py-2.5 border-gray-200 shadow-none">
                        </div>
                        <select v-model="filterStatus" class="form-input w-40 py-2.5 border-gray-200 shadow-none"><option value="">全部狀態</option><option value="PENDING">待付款</option><option value="PAID">已付款</option><option value="CANCELLED">已取消</option></select>
                    </div>
                    <div class="bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden">
                        <table class="w-full data-table">
                            <thead><tr><th>訂單編號</th><th>學員資料</th><th>課程 / 金額</th><th>付款資訊</th><th>狀態</th><th class="text-right">操作</th></tr></thead>
                            <tbody>
                                <tr v-for="o in filteredOrders" :key="o.orderId">
                                    <td class="font-mono text-xs text-gray-500">
                                        <div class="text-gray-800 font-bold text-sm mb-1">{{ o.orderId.slice(0,8) }}</div>
                                        {{ formatTime(o.createdAt) }}
                                    </td>
                                    <td>
                                        <div class="font-bold text-gray-800">{{ o.name }}</div>
                                        <div class="text-xs text-gray-500">{{ o.phone }}</div>
                                    </td>
                                    <td>
                                        <div class="text-sm text-gray-700 mb-1 max-w-[200px] truncate" :title="o.courseId">{{ o.courseId }}</div>
                                        <div class="text-[#06C755] font-bold">${{ o.amount }}</div>
                                    </td>
                                    <td>
                                        <span v-if="o.remittance" class="font-mono bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs">後五碼: {{ o.remittance }}</span>
                                        <span v-else class="text-gray-300 text-xs">-</span>
                                    </td>
                                    <td>
                                        <span class="status-pill" 
                                            :class="{'bg-yellow-50 text-yellow-700': o.status==='PENDING', 'bg-green-50 text-green-700': o.status==='PAID', 'bg-gray-100 text-gray-500': o.status==='CANCELLED'}">
                                            <span class="w-2 h-2 rounded-full" :class="{'bg-yellow-400': o.status==='PENDING', 'bg-green-500': o.status==='PAID', 'bg-gray-400': o.status==='CANCELLED'}"></span>
                                            {{ getStatusLabel(o.status) }}
                                        </span>
                                    </td>
                                    <td class="text-right">
                                        <button @click="openOrder(o)" class="btn-outline px-3 py-1.5 text-xs">編輯</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Members Table -->
                <div v-if="currentTab==='members'">
                    <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm mb-6 max-w-2xl">
                        <div class="relative">
                            <i class="fas fa-search absolute left-3 top-3.5 text-gray-400"></i>
                            <input v-model="searchTerm" placeholder="搜尋會員 (姓名、身分證...)" class="form-input pl-10 py-2.5 border-gray-200 shadow-none">
                        </div>
                    </div>
                    <div class="bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden">
                        <table class="w-full data-table">
                            <thead><tr><th>姓名</th><th>身分證字號</th><th>家人數</th><th class="text-right">操作</th></tr></thead>
                            <tbody>
                                <tr v-for="u in filteredUsers" :key="u.userId">
                                    <td class="flex items-center gap-3">
                                        <div class="w-9 h-9 rounded-full bg-gray-100 flex items-center justify-center text-gray-400 border border-gray-200 text-sm font-bold">{{ u.name[0] }}</div>
                                        <span class="font-bold text-gray-800">{{ u.name }}</span>
                                    </td>
                                    <td class="font-mono text-gray-600">{{ u.nationalId }}</td>
                                    <td><span class="bg-blue-50 text-blue-600 px-2.5 py-1 rounded-full text-xs font-bold border border-blue-100">{{ u.familyMembers ? u.familyMembers.length : 0 }} 位</span></td>
                                    <td class="text-right">
                                        <button @click="openMember(u)" class="btn-outline px-3 py-1.5 text-xs text-[#06C755] border-green-200 hover:bg-green-50">查看詳情</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- *** DRAWERS (抽屜式編輯區) - 放置於最外層 *** -->

    <!-- 1. Member Drawer -->
    <transition name="drawer">
        <div v-if="showMemberModal" class="relative z-[9999]">
            <div class="drawer-overlay" @click="showMemberModal=false"></div>
            <div class="drawer-content">
                <!-- Header -->
                <div class="h-16 px-8 border-b border-gray-100 flex justify-between items-center bg-white shrink-0">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-[#06C755] flex items-center justify-center text-white font-bold text-xl">{{ editingMember.name[0] }}</div>
                        <div><h3 class="text-lg font-bold text-gray-800">{{ editingMember.name }}</h3><p class="text-xs text-gray-400">ID: {{ editingMember.userId.slice(0,8) }}...</p></div>
                    </div>
                    <button @click="showMemberModal=false" class="btn-icon"><i class="fas fa-times text-xl"></i></button>
                </div>
                
                <!-- Scrollable Body -->
                <div class="flex-1 overflow-y-auto p-8 bg-[#f9fafb]">
                    <!-- Main Profile -->
                    <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm mb-6">
                        <h4 class="text-sm font-bold text-gray-800 mb-6 flex items-center"><i class="fas fa-user-circle mr-2 text-[#06C755]"></i> 主帳號資料</h4>
                        <form @submit.prevent="saveMember">
                            <div class="grid grid-cols-2 gap-6 form-group">
                                <div><label class="form-label">姓名</label><input v-model="editingMember.name" class="form-input"></div>
                                <div><label class="form-label">身分證</label><input v-model="editingMember.nationalId" class="form-input" readonly></div>
                            </div>
                            <div class="grid grid-cols-2 gap-6 form-group">
                                <div><label class="form-label">電話</label><input v-model="editingMember.phone" class="form-input"></div>
                                <div><label class="form-label">生日</label><input v-model="editingMember.birthday" type="date" class="form-input"></div>
                            </div>
                            <div class="form-group"><label class="form-label">地址</label><input v-model="editingMember.address" class="form-input"></div>
                            <div class="form-group"><label class="form-label text-blue-600">健康備註</label><textarea v-model="editingMember.healthNote" rows="3" class="form-textarea bg-blue-50/50 border-blue-100"></textarea></div>
                            <div class="form-group"><label class="form-label text-yellow-600">內部管理備註</label><textarea v-model="editingMember.notes" rows="3" class="form-textarea bg-yellow-50/50 border-yellow-200"></textarea></div>
                        </form>
                    </div>

                    <!-- Family List -->
                    <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                        <div class="flex justify-between items-center mb-6">
                            <h4 class="text-sm font-bold text-gray-800 flex items-center"><i class="fas fa-users mr-2 text-[#06C755]"></i> 家人名單</h4>
                            <span class="bg-gray-100 px-2 py-1 rounded text-xs font-bold text-gray-600">{{ editingMember.familyMembers ? editingMember.familyMembers.length : 0 }}</span>
                        </div>
                        <div v-if="!editingMember.familyMembers || editingMember.familyMembers.length===0" class="text-center py-8 text-gray-300 border-2 border-dashed border-gray-100 rounded-lg">無家人資料</div>
                        <div v-else class="space-y-3">
                            <div v-for="fm in editingMember.familyMembers" :key="fm.userId" class="p-4 rounded-lg border border-gray-100 hover:border-[#06C755] hover:bg-[#f0f9f3] transition group bg-white">
                                <div class="flex justify-between mb-2">
                                    <div class="flex items-center gap-2">
                                        <span class="font-bold text-gray-800">{{ fm.name }}</span>
                                        <span class="text-xs bg-white border border-gray-200 px-2 py-0.5 rounded text-gray-500">{{ fm.relation }}</span>
                                    </div>
                                    <span v-if="fm.identity" class="text-xs bg-gray-100 px-2 py-0.5 rounded">{{ fm.identity }}</span>
                                </div>
                                <div class="text-xs text-gray-500 grid grid-cols-2"><span>ID: {{ fm.nationalId }}</span><span>生日: {{ formatDate(fm.birthday) }}</span></div>
                                <div v-if="fm.healthStatus==='需備註'" class="mt-2 text-xs text-red-500 bg-red-50 p-2 rounded">{{ fm.healthNote }}</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <div class="h-20 px-8 border-t border-gray-200 bg-white flex items-center justify-end gap-3 shrink-0">
                    <button @click="showMemberModal=false" class="btn-outline">取消</button>
                    <button @click="saveMember" class="btn-primary w-32">儲存變更</button>
                </div>
            </div>
        </div>
    </transition>

    <!-- 2. Course Drawer -->
    <transition name="drawer">
        <div v-if="showCourseModal" class="relative z-[9999]">
            <div class="drawer-overlay" @click="showCourseModal=false"></div>
            <div class="drawer-content">
                <div class="h-16 px-8 border-b border-gray-100 flex justify-between items-center bg-white">
                    <h3 class="text-lg font-bold text-gray-800">{{ isEditingCourse ? '編輯課程' : '新增課程' }}</h3>
                    <button @click="showCourseModal=false" class="btn-icon"><i class="fas fa-times text-xl"></i></button>
                </div>
                <div class="flex-1 overflow-y-auto p-8 bg-[#f9fafb]">
                    <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm space-y-6">
                        <div class="grid grid-cols-2 gap-6">
                            <div class="form-group"><label class="form-label">代碼</label><input v-model="courseForm.id" class="form-input" :readonly="isEditingCourse"></div>
                            <div class="form-group"><label class="form-label">名稱</label><input v-model="courseForm.name" class="form-input"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-6 bg-gray-50 p-4 rounded-lg border border-gray-100">
                            <div class="form-group"><label class="form-label">開始日期</label><input v-model="courseForm.startDate" type="date" class="form-input"></div>
                            <div class="form-group"><label class="form-label">結束日期</label><input v-model="courseForm.endDate" type="date" class="form-input"></div>
                            <div class="col-span-2 form-group"><label class="form-label">上課時段 (手寫)</label><input v-model="courseForm.startTime" type="text" class="form-input" placeholder="例: 每週三 14:00-16:00"></div>
                        </div>
                        <div class="grid grid-cols-3 gap-6">
                            <div class="form-group"><label class="form-label text-green-600">價格</label><input v-model="courseForm.price" type="number" class="form-input font-bold text-lg text-[#06C755]"></div>
                            <div class="form-group"><label class="form-label">名額</label><input v-model="courseForm.capacity" type="number" class="form-input"></div>
                            <div class="form-group"><label class="form-label">總堂數</label><input v-model="courseForm.totalSessions" type="number" class="form-input"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-6">
                            <div class="form-group"><label class="form-label">地點</label><input v-model="courseForm.location" class="form-input"></div>
                            <div class="form-group"><label class="form-label">教練</label><input v-model="courseForm.instructor" class="form-input"></div>
                        </div>
                    </div>
                </div>
                <div class="h-20 px-8 border-t border-gray-200 bg-white flex items-center justify-end gap-3">
                    <button @click="showCourseModal=false" class="btn-outline">取消</button>
                    <button @click="submitCourse" class="btn-primary w-32">確認送出</button>
                </div>
            </div>
        </div>
    </transition>

    <!-- 3. Order Drawer -->
    <transition name="drawer">
        <div v-if="showOrderModal" class="relative z-[9999]">
            <div class="drawer-overlay" @click="showOrderModal=false"></div>
            <div class="drawer-content !w-[600px]">
                <div class="h-16 px-8 border-b border-gray-100 flex justify-between items-center bg-white">
                    <h3 class="text-lg font-bold text-gray-800">編輯訂單</h3>
                    <button @click="showOrderModal=false" class="btn-icon"><i class="fas fa-times text-xl"></i></button>
                </div>
                <div class="flex-1 overflow-y-auto p-8 bg-[#f9fafb]">
                    <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm mb-6">
                        <div class="flex justify-between items-center mb-4 pb-4 border-b border-gray-100">
                            <div><div class="text-xs text-gray-400 font-bold uppercase mb-1">訂單編號</div><div class="font-mono font-bold text-gray-800">{{ editingOrder.orderId }}</div></div>
                            <div class="text-right"><div class="text-xs text-gray-400 font-bold uppercase mb-1">建立時間</div><div class="text-sm text-gray-600">{{ formatTime(editingOrder.createdAt) }}</div></div>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-blue-50 text-blue-500 flex items-center justify-center font-bold text-xl"><i class="fas fa-user"></i></div>
                            <div><div class="font-bold text-gray-800">{{ editingOrder.name }}</div><div class="text-sm text-gray-500">{{ editingOrder.phone }}</div></div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm space-y-6">
                        <div class="grid grid-cols-2 gap-6">
                            <div class="form-group"><label class="form-label">狀態</label><select v-model="editingOrder.status" class="form-input"><option value="PENDING">待付款</option><option value="PAID">已付款</option><option value="CANCELLED">已取消</option></select></div>
                            <div class="form-group"><label class="form-label">金額</label><input v-model="editingOrder.amount" type="number" class="form-input font-bold text-[#06C755]"></div>
                        </div>
                        <div class="form-group"><label class="form-label">匯款後五碼</label><input v-model="editingOrder.remittance" class="form-input font-mono tracking-widest text-center" placeholder="-----"></div>
                        <div class="form-group"><label class="form-label">備註</label><textarea v-model="editingOrder.note" rows="4" class="form-textarea" placeholder="訂單備註..."></textarea></div>
                    </div>
                </div>
                <div class="h-20 px-8 border-t border-gray-200 bg-white flex items-center justify-end gap-3">
                    <button @click="showOrderModal=false" class="btn-outline">取消</button>
                    <button @click="saveOrder" class="btn-primary w-32">儲存變更</button>
                </div>
            </div>
        </div>
    </transition>

</div>

<script>
    const { createApp, ref, computed } = Vue;
    const API_ENDPOINT = 'https://sport-island.fangwl591021.workers.dev/'; 

    createApp({
        setup() {
            const isLoggedIn = ref(false), password = ref(''), isLoading = ref(false), currentTab = ref('courses'), error = ref('');
            const courses = ref([]), orders = ref([]), users = ref([]);
            
            const showMemberModal = ref(false), editingMember = ref({ familyMembers: [] });
            const showCourseModal = ref(false), isEditingCourse = ref(false);
            const courseForm = ref({id:'',name:'',startDate:'',endDate:'',startTime:'',price:0,capacity:0,totalSessions:1,location:'',instructor:''});
            const showOrderModal = ref(false), editingOrder = ref({});
            
            const searchTerm = ref(''), filterStatus = ref('');
            const tabName = computed(() => ({'courses':'課程管理','orders':'訂單管理','members':'會員管理'}[currentTab.value]));

            // Filter Logic
            const filteredOrders = computed(() => orders.value.filter(o => (o.name+o.phone+o.nationalId).toLowerCase().includes(searchTerm.value.toLowerCase()) && (!filterStatus.value || o.status===filterStatus.value)));
            const filteredUsers = computed(() => currentTab.value!=='members'?[]:users.value.filter(u => (u.name+u.nationalId+u.phone).toLowerCase().includes(searchTerm.value.toLowerCase())));
            const totalEnrolled = computed(() => courses.value.reduce((acc, c) => acc + c.enrolled, 0));

            // API Calls
            const callApi = async (action, payload={}) => {
                const res = await fetch(API_ENDPOINT, { method:'POST', body:JSON.stringify({action, payload:{password:password.value, ...payload}}) });
                const json = await res.json();
                if(json.status!=='success') throw new Error(json.message);
                return json.data;
            };

            const login = async () => {
                isLoading.value=true; error.value='';
                try { await callApi('ADMIN_LOGIN'); isLoggedIn.value=true; fetchData(); } catch(e) { error.value='密碼錯誤'; } finally { isLoading.value=false; }
            };
            const logout = () => { isLoggedIn.value=false; password.value=''; };

            const fetchData = async () => {
                isLoading.value = true;
                try {
                    const data = await callApi('ADMIN_GET_DATA');
                    courses.value = data.courses; orders.value = data.orders.reverse(); users.value = data.users.reverse();
                } catch(e){ alert('資料載入失敗'); } finally { isLoading.value=false; }
            };

            const updateStatus = async (oid, st) => {
                if(!confirm('確認更新?')) return;
                await callApi('ADMIN_UPDATE_ORDER', {orderData:{orderId:oid, status:st}}); fetchData();
            };

            // Editors
            const openAddCourse = () => { isEditingCourse.value=false; courseForm.value={id:'',name:'',startDate:'',endDate:'',startTime:'',price:0,capacity:0,totalSessions:1,location:'',instructor:''}; showCourseModal.value=true; };
            const openEditCourse = (c) => { 
                isEditingCourse.value=true; 
                const fmt = d => d ? new Date(d).toISOString().split('T')[0] : '';
                courseForm.value = {...c, startDate:fmt(c.startDate), endDate:fmt(c.endDate)}; 
                showCourseModal.value=true; 
            };
            const submitCourse = async () => {
                try { await callApi(isEditingCourse.value?'ADMIN_UPDATE_COURSE':'ADMIN_ADD_COURSE', courseForm.value); alert('成功'); showCourseModal.value=false; fetchData(); } catch(e){ alert('失敗'); }
            };

            const openMember = (u) => { 
                let copy = JSON.parse(JSON.stringify(u));
                if(copy.birthday) copy.birthday = new Date(copy.birthday).toISOString().split('T')[0];
                if(!copy.familyMembers) copy.familyMembers=[];
                editingMember.value = copy; showMemberModal.value=true; 
            };
            const saveMember = async () => {
                if(!confirm('確認儲存?')) return;
                try { await callApi('ADMIN_UPDATE_MEMBER', {memberData:editingMember.value}); alert('已儲存'); showMemberModal.value=false; fetchData(); } catch(e){ alert('失敗'); }
            };

            const openOrder = (o) => { editingOrder.value={...o}; showOrderModal.value=true; };
            const saveOrder = async () => {
                if(!confirm('確認儲存?')) return;
                try { await callApi('ADMIN_UPDATE_ORDER', {orderData:editingOrder.value}); alert('已儲存'); showOrderModal.value=false; fetchData(); } catch(e){ alert('失敗'); }
            };

            // Formatters
            const formatDate = d => d ? new Date(d).toLocaleDateString('zh-TW') : '-';
            const formatTime = d => d ? new Date(d).toLocaleString('zh-TW', {year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', hour12:false}) : '-';

            return { 
                isLoggedIn, password, isLoading, error, currentTab, tabName, courses, totalEnrolled, 
                filteredOrders, filteredUsers, searchTerm, filterStatus,
                showMemberModal, editingMember, showCourseModal, isEditingCourse, courseForm, showOrderModal, editingOrder,
                login, logout, fetchData, updateStatus, openOrder, saveOrder, openAddCourse, openEditCourse, submitCourse, openMember, saveMember,
                formatDate, formatTime, getStatusLabel: s=>({'PENDING':'待付款','PAID':'已付款','CANCELLED':'已取消'}[s]||s)
            };
        }
    }).mount('#app');
</script>
</body>
</html>
