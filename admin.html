<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>運動島管理後台</title>
    <!-- Vue 3 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Noto Sans TC -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        [v-cloak] { display: none; }
        
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: #f0f2f5;
            color: #1e1e2d;
            overflow: hidden; 
        }

        /* --- Sidebar (LINE OA 風格: 白底垂直) --- */
        .sidebar {
            width: 240px;
            background-color: #ffffff;
            border-right: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            z-index: 50;
        }
        
        .sidebar-header {
            height: 64px;
            display: flex;
            align-items: center;
            padding: 0 20px;
            border-bottom: 1px solid #f3f4f6;
        }

        .menu-category {
            padding: 20px 20px 8px 20px;
            font-size: 11px;
            font-weight: 700;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .menu-item {
            display: flex;
            align-items: center;
            width: 100%;
            height: 48px;
            padding: 0 20px;
            color: #4b5563;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border-left: 4px solid transparent;
            transition: all 0.2s;
        }

        .menu-item:hover {
            background-color: #f0fbf5;
            color: #06C755;
        }

        .menu-item.active {
            background-color: #f0fbf5;
            color: #06C755;
            border-left-color: #06C755;
            font-weight: 700;
        }

        .menu-icon { width: 24px; text-align: center; margin-right: 12px; font-size: 16px; }

        /* --- Main Content --- */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: #f0f2f5;
            overflow: hidden;
            position: relative;
        }

        .top-header {
            height: 64px;
            background-color: #ffffff;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 32px;
            flex-shrink: 0;
        }

        .content-scroll-area { flex: 1; overflow-y: auto; padding: 32px; }

        /* --- Components --- */
        .card {
            background: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            overflow: hidden;
            margin-bottom: 24px;
        }

        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th {
            text-align: left; padding: 16px 24px; background-color: #f9fafb;
            color: #6b7280; font-size: 12px; font-weight: 700; border-bottom: 1px solid #e5e7eb;
        }
        .data-table td {
            padding: 16px 24px; border-bottom: 1px solid #f3f4f6;
            font-size: 14px; color: #374151; vertical-align: middle;
        }
        .data-table tr:hover { background-color: #f9fafb; }

        .btn-line-green {
            background-color: #06C755; color: white; padding: 8px 16px; border-radius: 6px;
            font-weight: 700; font-size: 14px; transition: background 0.2s;
            display: inline-flex; align-items: center; gap: 6px;
        }
        .btn-line-green:hover { background-color: #05b34c; }

        .btn-white {
            background-color: white; border: 1px solid #d1d5db; color: #374151;
            padding: 8px 16px; border-radius: 6px; font-weight: 500; font-size: 14px; transition: all 0.2s;
        }
        .btn-white:hover { border-color: #06C755; color: #06C755; background-color: #f0fbf5; }

        .input-line {
            width: 100%; border: 1px solid #d1d5db; border-radius: 6px; padding: 10px 12px;
            font-size: 14px; outline: none; transition: border 0.2s;
        }
        .input-line:focus { border-color: #06C755; box-shadow: 0 0 0 2px rgba(6,199,85,0.1); }
        .label-line { display: block; font-size: 12px; font-weight: 700; color: #6b7280; margin-bottom: 6px; }

        /* --- Modal (Central Popup) --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.6); backdrop-filter: blur(2px);
            z-index: 9999; display: flex; align-items: center; justify-content: center;
        }
        .modal-container {
            background: white; width: 95%; height: 95%; max-width: 1400px;
            border-radius: 12px; display: flex; flex-direction: column;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            animation: popIn 0.2s ease-out;
        }
        @keyframes popIn { 0% { transform: scale(0.95); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        .section-title {
            font-size: 14px; font-weight: 700; color: #111827;
            padding-bottom: 8px; border-bottom: 1px solid #e5e7eb; margin-bottom: 16px;
            display: flex; align-items: center; gap: 8px;
        }
        
        /* 針對課程編輯的特殊樣式 */
        .settings-box {
            background-color: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-bottom: 16px;
        }
        .toggle-switch {
            position: relative; display: inline-block; width: 44px; height: 24px;
        }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc; transition: .4s; border-radius: 34px;
        }
        .slider:before {
            position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px;
            background-color: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: #06C755; }
        input:checked + .slider:before { transform: translateX(20px); }

    </style>
</head>
<body>

<div id="app" v-cloak class="flex h-full w-full">

    <!-- LOGIN -->
    <div v-if="!isLoggedIn" class="fixed inset-0 z-[100] flex items-center justify-center bg-[#f0f2f5]">
        <div class="bg-white p-10 rounded-xl shadow-lg w-[400px] border border-gray-200 text-center">
            <div class="w-16 h-16 bg-[#06C755] rounded-xl flex items-center justify-center mx-auto mb-6 text-white text-3xl">
                <i class="fas fa-running"></i>
            </div>
            <h1 class="text-xl font-bold text-gray-800 mb-6">運動島管理後台</h1>
            <form @submit.prevent="login">
                <input v-model="password" type="password" class="input-line mb-4" placeholder="請輸入管理密碼">
                <button :disabled="isLoading" class="w-full btn-line-green py-3 justify-center">
                    {{ isLoading ? '登入中...' : '登入系統' }}
                </button>
                <p v-if="error" class="text-red-500 text-sm mt-4">{{ error }}</p>
            </form>
        </div>
    </div>

    <!-- MAIN DASHBOARD -->
    <template v-else>
        <!-- SIDEBAR -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <span class="bg-[#06C755] text-white px-2 py-0.5 rounded text-xs font-bold mr-2">LINE OA</span>
                <span class="font-bold text-gray-800 text-lg">運動島管理</span>
            </div>
            
            <div class="flex-1 overflow-y-auto py-2">
                <div class="menu-category">MENU</div>
                <div class="menu-item" :class="{ active: currentTab === 'courses' }" @click="currentTab = 'courses'">
                    <i class="fas fa-chalkboard-teacher menu-icon"></i> 課程管理
                </div>
                <div class="menu-item" :class="{ active: currentTab === 'orders' }" @click="currentTab = 'orders'">
                    <i class="fas fa-file-invoice-dollar menu-icon"></i> 訂單管理
                </div>
                <div class="menu-item" :class="{ active: currentTab === 'members' }" @click="currentTab = 'members'">
                    <i class="fas fa-users menu-icon"></i> 會員管理
                </div>
            </div>

            <div class="p-4 border-t border-gray-100 bg-gray-50">
                <div class="flex items-center gap-3 mb-3">
                    <div class="w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center text-xs font-bold text-white">A</div>
                    <span class="text-sm font-bold text-gray-600">系統管理員</span>
                </div>
                <button @click="logout" class="w-full btn-white text-xs py-1">登出</button>
            </div>
        </aside>

        <!-- CONTENT -->
        <main class="main-content">
            <header class="top-header">
                <h2 class="text-xl font-bold text-gray-800 pl-3 border-l-4 border-[#06C755]">{{ tabName }}</h2>
                <button @click="fetchData" class="btn-white text-gray-500 hover:text-[#06C755]">
                    <i class="fas fa-sync-alt" :class="{'fa-spin':isLoading}"></i> 資料同步
                </button>
            </header>

            <div class="content-scroll-area">
                
                <!-- COURSES TAB -->
                <div v-if="currentTab === 'courses'">
                    <div class="flex justify-between items-end mb-6">
                        <div class="flex gap-4">
                            <div class="bg-white px-6 py-4 rounded-lg border border-gray-200 shadow-sm">
                                <div class="text-xs text-gray-400 font-bold uppercase">上架課程</div>
                                <div class="text-3xl font-bold text-gray-800 mt-1">{{ courses.length }}</div>
                            </div>
                        </div>
                        <button @click="openAddCourse" class="btn-line-green"><i class="fas fa-plus"></i> 新增課程</button>
                    </div>

                    <div class="card">
                        <table class="data-table">
                            <thead><tr><th>課程資訊</th><th>類型/時間</th><th>教練/費用</th><th>報名進度</th><th class="text-right">操作</th></tr></thead>
                            <tbody>
                                <tr v-for="c in courses" :key="c.id">
                                    <td class="w-1/3">
                                        <div class="font-bold text-base text-gray-800">{{ c.name }}</div>
                                        <div class="text-xs text-gray-400 font-mono mt-1 bg-gray-100 inline-block px-1 rounded">{{ c.id }}</div>
                                    </td>
                                    <td>
                                        <div class="flex gap-2 mb-1">
                                            <span class="text-xs bg-blue-50 text-blue-600 px-2 py-0.5 rounded border border-blue-100">{{ c.type }}</span>
                                            <span class="text-xs bg-gray-100 text-gray-600 px-2 py-0.5 rounded border border-gray-200">{{ c.timeSlotType }}</span>
                                        </div>
                                        <div class="text-sm text-gray-600">{{ formatDate(c.startDate) }} ~ {{ formatDate(c.endDate) }}</div>
                                        <div v-if="c.startTime" class="text-xs text-[#06C755] font-bold mt-1">{{ c.startTime }}</div>
                                    </td>
                                    <td>
                                        <div class="text-sm text-gray-700">{{ c.instructor || '未定' }}</div>
                                        <div class="text-[#06C755] font-bold mt-1">${{ c.price }}</div>
                                        <div v-if="c.earlyBirdPrice > 0" class="text-xs text-orange-500 mt-1">早鳥: ${{ c.earlyBirdPrice }}</div>
                                    </td>
                                    <td>
                                        <div class="text-xs text-gray-500 mb-1">{{ c.enrolled }} / {{ c.capacity }} 人</div>
                                        <div class="w-24 bg-gray-200 rounded-full h-1.5"><div class="bg-[#06C755] h-1.5 rounded-full" :style="{width: Math.min((c.enrolled/c.capacity)*100, 100) + '%'}"></div></div>
                                    </td>
                                    <td class="text-right">
                                        <button @click="openEditCourse(c)" class="text-gray-400 hover:text-[#06C755] p-2"><i class="fas fa-pen"></i></button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- ORDERS TAB -->
                <div v-if="currentTab === 'orders'">
                    <div class="card">
                        <table class="data-table">
                            <thead><tr><th>訂單編號</th><th>學員</th><th>金額</th><th>狀態</th><th class="text-right">操作</th></tr></thead>
                            <tbody>
                                <tr v-for="o in filteredOrders" :key="o.orderId">
                                    <td><div class="font-bold">{{ o.orderId.slice(0,8) }}</div><div class="text-xs text-gray-400">{{ formatTime(o.createdAt) }}</div></td>
                                    <td>{{ o.name }}<br><span class="text-xs text-gray-500">{{ o.phone }}</span></td>
                                    <td class="font-bold text-[#06C755]">${{ o.amount }}</td>
                                    <td><span class="px-2 py-1 rounded text-xs font-bold" :class="getStatusClass(o.status)">{{ getStatusLabel(o.status) }}</span></td>
                                    <td class="text-right"><button @click="openOrder(o)" class="btn-white text-xs py-1">編輯</button></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- MEMBERS TAB -->
                <div v-if="currentTab === 'members'">
                    <div class="mb-4 relative max-w-md">
                        <input v-model="searchTerm" class="input-line pl-10" placeholder="搜尋會員...">
                        <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                    </div>
                    <div class="card">
                        <table class="data-table">
                            <thead><tr><th>姓名</th><th>身分證</th><th>家人數</th><th class="text-right">操作</th></tr></thead>
                            <tbody>
                                <tr v-for="u in filteredUsers" :key="u.userId">
                                    <td class="font-bold">{{ u.name }}</td>
                                    <td class="font-mono">{{ u.nationalId }}</td>
                                    <td><span class="bg-blue-50 text-blue-600 px-2 py-1 rounded text-xs">{{ u.familyMembers?.length || 0 }}</span></td>
                                    <td class="text-right"><button @click="openMember(u)" class="text-[#06C755] font-bold text-sm">詳情</button></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </main>
    </template>

    <!-- *** COURSE MODAL (升級版) *** -->
    <div v-if="showCourseModal" class="modal-overlay" @click.self="showCourseModal=false">
        <div class="modal-container">
            <div class="h-16 px-8 border-b border-gray-200 flex justify-between items-center bg-white shrink-0">
                <h3 class="text-lg font-bold text-gray-800">{{ isEditingCourse ? '編輯課程' : '新增課程' }}</h3>
                <button @click="showCourseModal=false" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
            </div>
            
            <div class="flex-1 flex overflow-hidden">
                <!-- 左側：基本設定 -->
                <div class="w-1/2 p-8 overflow-y-auto border-r border-gray-200 bg-white">
                    <div class="section-title"><i class="fas fa-info-circle text-[#06C755]"></i> 基本資訊</div>
                    
                    <div class="grid grid-cols-2 gap-6 mb-6">
                        <div><label class="label-line">課程代碼</label><input v-model="courseForm.id" class="input-line" :readonly="isEditingCourse"></div>
                        <div><label class="label-line">課程名稱</label><input v-model="courseForm.name" class="input-line"></div>
                    </div>

                    <div class="settings-box">
                        <div class="grid grid-cols-2 gap-6">
                            <div>
                                <label class="label-line">課程類型</label>
                                <select v-model="courseForm.type" class="input-line bg-white">
                                    <option value="單日課程">單日課程 (無退費)</option>
                                    <option value="多日營隊">多日營隊 (可請假)</option>
                                </select>
                            </div>
                            <div>
                                <label class="label-line">時段屬性</label>
                                <select v-model="courseForm.timeSlotType" class="input-line bg-white">
                                    <option value="全日">全日班</option>
                                    <option value="上午">上午班</option>
                                    <option value="下午">下午班</option>
                                </select>
                            </div>
                        </div>
                        <p v-if="courseForm.type==='多日營隊'" class="text-xs text-orange-500 mt-2">
                            <i class="fas fa-exclamation-triangle"></i> 注意：多日營隊將允許使用者在報名時勾選請假日期（超過3天將無法報名）。
                        </p>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div><label class="label-line">開始日期</label><input v-model="courseForm.startDate" type="date" class="input-line"></div>
                        <div><label class="label-line">結束日期</label><input v-model="courseForm.endDate" type="date" class="input-line"></div>
                    </div>
                    <div class="mb-4"><label class="label-line">上課時段 (手寫)</label><input v-model="courseForm.startTime" type="text" class="input-line" placeholder="例: 09:00-16:00"></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="label-line">地點</label><input v-model="courseForm.location" class="input-line"></div>
                        <div><label class="label-line">教練</label><input v-model="courseForm.instructor" class="input-line"></div>
                    </div>
                </div>

                <!-- 右側：費用與進階 -->
                <div class="w-1/2 p-8 overflow-y-auto bg-[#fafafa]">
                    <div class="section-title"><i class="fas fa-dollar-sign text-[#06C755]"></i> 費用與規則</div>
                    
                    <div class="grid grid-cols-3 gap-6 mb-6">
                        <div><label class="label-line text-green-600">標準定價 ($)</label><input v-model="courseForm.price" type="number" class="input-line font-bold text-lg text-[#06C755]"></div>
                        <div><label class="label-line">總名額</label><input v-model="courseForm.capacity" type="number" class="input-line"></div>
                        <div><label class="label-line">總堂數 (計費基準)</label><input v-model="courseForm.totalSessions" type="number" class="input-line"></div>
                    </div>

                    <!-- 早鳥優惠 -->
                    <div class="settings-box bg-white">
                        <div class="flex items-center justify-between mb-4">
                            <label class="font-bold text-gray-700 flex items-center"><i class="fas fa-stopwatch mr-2 text-orange-500"></i> 早鳥優惠</label>
                            <label class="toggle-switch">
                                <input type="checkbox" v-model="hasEarlyBird">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div v-if="hasEarlyBird" class="grid grid-cols-2 gap-4">
                            <div><label class="label-line">早鳥價格 ($)</label><input v-model="courseForm.earlyBirdPrice" type="number" class="input-line"></div>
                            <div><label class="label-line">截止日期</label><input v-model="courseForm.earlyBirdDate" type="date" class="input-line"></div>
                        </div>
                    </div>

                    <!-- 設備租用 -->
                    <div class="settings-box bg-white">
                        <div class="flex items-center justify-between mb-4">
                            <label class="font-bold text-gray-700 flex items-center"><i class="fas fa-tools mr-2 text-blue-500"></i> 設備租用選項</label>
                            <button @click="addEquipment" class="text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded hover:bg-blue-100">+ 新增</button>
                        </div>
                        
                        <div v-if="equipList.length === 0" class="text-center text-gray-400 text-sm py-2">無租用項目</div>
                        
                        <div v-else class="space-y-3">
                            <div v-for="(eq, idx) in equipList" :key="idx" class="equip-row">
                                <input v-model="eq.name" placeholder="品項名稱 (如: 球拍)" class="input-line w-2/3">
                                <input v-model="eq.price" type="number" placeholder="$" class="input-line w-1/4">
                                <button @click="removeEquipment(idx)" class="text-gray-400 hover:text-red-500 px-2"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="h-20 px-8 border-t border-gray-200 bg-white flex items-center justify-end gap-3 shrink-0">
                <button @click="showCourseModal=false" class="btn-white">取消</button>
                <button @click="submitCourse" class="btn-line-green w-32 justify-center">儲存設定</button>
            </div>
        </div>
    </div>

    <!-- MEMBER MODAL -->
    <div v-if="showMemberModal" class="modal-overlay" @click.self="showMemberModal=false">
        <div class="modal-container" style="max-width:1000px;height:85%;">
            <div class="h-16 px-8 border-b border-gray-200 flex justify-between items-center bg-white shrink-0">
                <h3 class="text-lg font-bold text-gray-800">會員資料</h3>
                <button @click="showMemberModal=false" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="flex-1 flex overflow-hidden">
                <div class="w-1/2 p-8 overflow-y-auto border-r border-gray-200 bg-white">
                     <form @submit.prevent="saveMember" class="space-y-4">
                        <div class="grid grid-cols-2 gap-4"><div><label class="label-line">姓名</label><input v-model="editingMember.name" class="input-line"></div><div><label class="label-line">身分證</label><input v-model="editingMember.nationalId" class="input-line bg-gray-50" readonly></div></div>
                        <div class="grid grid-cols-2 gap-4"><div><label class="label-line">電話</label><input v-model="editingMember.phone" class="input-line"></div><div><label class="label-line">生日</label><input v-model="editingMember.birthday" type="date" class="input-line"></div></div>
                        <div><label class="label-line">地址</label><input v-model="editingMember.address" class="input-line"></div>
                        <div><label class="label-line text-blue-600">健康備註</label><textarea v-model="editingMember.healthNote" rows="3" class="input-line"></textarea></div>
                        <div><label class="label-line text-yellow-600">管理備註</label><textarea v-model="editingMember.notes" rows="3" class="input-line bg-yellow-50"></textarea></div>
                     </form>
                </div>
                <div class="w-1/2 p-8 overflow-y-auto bg-[#fafafa]">
                    <h4 class="text-xs font-bold text-gray-400 mb-4">家人名單 ({{ editingMember.familyMembers?.length || 0 }})</h4>
                    <div v-for="fm in editingMember.familyMembers" :key="fm.userId" class="bg-white p-3 rounded border border-gray-200 mb-2 shadow-sm">
                        <div class="font-bold">{{ fm.name }} <span class="text-xs bg-gray-100 px-2 rounded">{{ fm.relation }}</span></div>
                        <div class="text-xs text-gray-500">ID: {{ fm.nationalId }}</div>
                    </div>
                </div>
            </div>
            <div class="h-20 px-8 border-t border-gray-200 bg-white flex items-center justify-end gap-3 shrink-0">
                <button @click="showMemberModal=false" class="btn-white">取消</button><button @click="saveMember" class="btn-line-green w-32 justify-center">儲存</button>
            </div>
        </div>
    </div>
    
    <!-- ORDER MODAL -->
    <div v-if="showOrderModal" class="modal-overlay" @click.self="showOrderModal=false">
        <div class="modal-container" style="max-width:600px;height:auto;max-height:90vh;">
            <div class="h-16 px-8 border-b border-gray-200 flex justify-between items-center bg-white">
                <h3 class="text-lg font-bold text-gray-800">編輯訂單</h3><button @click="showOrderModal=false" class="text-gray-400"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-8 overflow-y-auto">
                 <div class="grid grid-cols-2 gap-4 mb-4">
                     <div><label class="label-line">狀態</label><select v-model="editingOrder.status" class="input-line"><option value="PENDING">待付款</option><option value="PAID">已付款</option><option value="CANCELLED">已取消</option></select></div>
                     <div><label class="label-line">金額</label><input v-model="editingOrder.amount" type="number" class="input-line"></div>
                 </div>
                 <div class="mb-4"><label class="label-line">匯款後五碼</label><input v-model="editingOrder.remittance" class="input-line"></div>
                 <div><label class="label-line">備註</label><textarea v-model="editingOrder.note" rows="3" class="input-line"></textarea></div>
            </div>
            <div class="h-20 px-8 border-t border-gray-200 bg-white flex items-center justify-end gap-3">
                <button @click="showOrderModal=false" class="btn-white">取消</button><button @click="saveOrder" class="btn-line-green justify-center">儲存</button>
            </div>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, computed, watch } = Vue;
    const API_ENDPOINT = 'https://sport-island.fangwl591021.workers.dev/'; 

    createApp({
        setup() {
            const isLoggedIn=ref(false), password=ref(''), isLoading=ref(false), currentTab=ref('courses'), error=ref('');
            const courses=ref([]), orders=ref([]), users=ref([]);
            const showCourseModal=ref(false), isEditingCourse=ref(false), showMemberModal=ref(false), showOrderModal=ref(false);
            const editingMember=ref({}), editingOrder=ref({});
            const searchTerm=ref(''), filterStatus=ref('');

            const courseForm = ref({
                id:'', name:'', startDate:'', endDate:'', startTime:'', price:0, capacity:0, totalSessions:1, location:'', instructor:'',
                type: '單日課程', timeSlotType: '全日', earlyBirdPrice: 0, earlyBirdDate: '', equipmentJson: '[]'
            });
            const hasEarlyBird = ref(false);
            const equipList = ref([]);

            watch(hasEarlyBird, (val) => { if(!val) { courseForm.value.earlyBirdPrice=0; courseForm.value.earlyBirdDate=''; } });
            
            const tabName = computed(() => ({'courses':'課程管理','orders':'訂單管理','members':'會員管理'}[currentTab.value]));
            const filteredOrders = computed(() => orders.value.filter(o => (o.name+o.phone).includes(searchTerm.value)));
            const filteredUsers = computed(() => users.value.filter(u => (u.name+u.nationalId).includes(searchTerm.value)));
            const totalEnrolled = computed(() => courses.value.reduce((acc, c) => acc + c.enrolled, 0));

            const callApi = async (action, payload={}) => {
                const res = await fetch(API_ENDPOINT, { method:'POST', body:JSON.stringify({action, payload:{password:password.value, ...payload}}) });
                const json = await res.json();
                if(json.status!=='success') throw new Error(json.message);
                return json.data;
            };

            const login = async () => { isLoading.value=true; try { await callApi('ADMIN_LOGIN'); isLoggedIn.value=true; fetchData(); } catch(e){ error.value='密碼錯誤'; } finally { isLoading.value=false; } };
            const logout = () => { isLoggedIn.value=false; password.value=''; };
            const fetchData = async () => { 
                isLoading.value=true; 
                try { const d = await callApi('ADMIN_GET_DATA'); courses.value=d.courses; orders.value=d.orders.reverse(); users.value=d.users.reverse(); } catch(e){ alert('Error'); } 
                isLoading.value=false; 
            };

            const openAddCourse = () => { 
                isEditingCourse.value=false; 
                courseForm.value={id:'',name:'',startDate:'',endDate:'',startTime:'',price:0,capacity:0,totalSessions:1,location:'',instructor:'', type:'單日課程', timeSlotType:'全日', earlyBirdPrice:0, earlyBirdDate:'', equipmentJson:'[]'}; 
                hasEarlyBird.value=false; equipList.value=[];
                showCourseModal.value=true; 
            };
            
            const openEditCourse = (c) => { 
                isEditingCourse.value=true;
                const fmt = d => d ? new Date(d).toISOString().split('T')[0] : '';
                courseForm.value = {...c, startDate:fmt(c.startDate), endDate:fmt(c.endDate), earlyBirdDate:fmt(c.earlyBirdDate)};
                hasEarlyBird.value = c.earlyBirdPrice > 0;
                try { equipList.value = JSON.parse(c.equipmentJson || '[]'); } catch(e) { equipList.value=[]; }
                showCourseModal.value=true; 
            };

            const addEquipment = () => equipList.value.push({name:'', price:0});
            const removeEquipment = (i) => equipList.value.splice(i,1);

            const submitCourse = async () => {
                courseForm.value.equipmentJson = JSON.stringify(equipList.value);
                const action = isEditingCourse.value ? 'ADMIN_UPDATE_COURSE' : 'ADMIN_ADD_COURSE';
                try { await callApi(action, courseForm.value); alert('成功'); showCourseModal.value=false; fetchData(); } catch(e){ alert('失敗'); }
            };

            const openMember = (u) => { editingMember.value=JSON.parse(JSON.stringify(u)); showMemberModal.value=true; };
            const saveMember = async () => { await callApi('ADMIN_UPDATE_MEMBER', {memberData:editingMember.value}); showMemberModal.value=false; fetchData(); };
            const openOrder = (o) => { editingOrder.value={...o}; showOrderModal.value=true; };
            const saveOrder = async () => { await callApi('ADMIN_UPDATE_ORDER', {orderData:editingOrder.value}); showOrderModal.value=false; fetchData(); };

            const formatDate = d => d ? new Date(d).toLocaleDateString('zh-TW') : '-';
            const formatTime = d => d ? new Date(d).toLocaleString('zh-TW',{hour12:false}) : '-';
            const getStatusLabel = s => ({'PENDING':'待付','PAID':'已付','CANCELLED':'取消'}[s]||s);
            const getStatusClass = s => ({'PENDING':'bg-yellow-100 text-yellow-800','PAID':'bg-green-100 text-green-800','CANCELLED':'bg-gray-100'}[s]);

            return { 
                isLoggedIn, password, isLoading, error, currentTab, tabName, courses, orders, users, totalEnrolled, 
                filteredOrders, filteredUsers, searchTerm, filterStatus,
                showCourseModal, isEditingCourse, courseForm, hasEarlyBird, equipList,
                showMemberModal, editingMember, showOrderModal, editingOrder,
                login, logout, fetchData, openAddCourse, openEditCourse, submitCourse, addEquipment, removeEquipment,
                openMember, saveMember, openOrder, saveOrder,
                formatDate, formatTime, getStatusLabel, getStatusClass
            };
        }
    }).mount('#app');
</script>
</body>
</html>
