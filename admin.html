<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>運動島管理後台</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        [v-cloak] { display: none !important; }
        :root { --line-green: #06C755; --bg-body: #f5f6f8; --text-main: #111827; }
        body { font-family: 'Noto Sans TC', sans-serif; background: var(--bg-body); color: var(--text-main); overflow: hidden; }
        .sidebar { width: 240px; background: white; border-right: 1px solid #e5e7eb; display: flex; flex-direction: column; flex-shrink: 0; z-index: 50; }
        .menu-item { display: flex; align-items: center; width: 100%; height: 48px; padding: 0 20px; color: #4b5563; font-size: 14px; font-weight: 500; cursor: pointer; border-left: 4px solid transparent; transition: all 0.2s; }
        .menu-item.active { background-color: #f0fbf5; color: #06C755; border-left-color: #06C755; font-weight: 700; }
        .main-content { flex: 1; display: flex; flex-direction: column; background: #f0f2f5; overflow: hidden; }
        .top-header { height: 64px; background: white; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; justify-content: space-between; padding: 0 32px; }
        .content-scroll { flex: 1; overflow-y: auto; padding: 32px; }
        .card { background: white; border: 1px solid #e5e7eb; border-radius: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); margin-bottom: 24px; overflow: hidden; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th { text-align: left; padding: 16px 24px; background: #f9fafb; color: #6b7280; font-size: 12px; font-weight: 700; border-bottom: 1px solid #e5e7eb; }
        .data-table td { padding: 16px 24px; border-bottom: 1px solid #f3f4f6; font-size: 14px; }
        .btn-green { background: var(--line-green); color: white; padding: 8px 16px; border-radius: 6px; font-weight: 700; font-size: 14px; display: inline-flex; align-items: center; gap: 6px; }
        .btn-white { background: white; border: 1px solid #d1d5db; color: #374151; padding: 8px 16px; border-radius: 6px; font-weight: 500; font-size: 14px; }
        .input-line { width: 100%; border: 1px solid #d1d5db; border-radius: 6px; padding: 8px 12px; font-size: 14px; outline: none; transition: border 0.2s; }
        .input-line:focus { border-color: #06C755; }
        .label-line { display: block; font-size: 12px; font-weight: 700; color: #6b7280; margin-bottom: 4px; }
        .modal-mask { position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(2px); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .modal-pop { background: white; width: 95%; height: 95%; max-width: 1400px; border-radius: 12px; display: flex; flex-direction: column; box-shadow: 0 25px 50px rgba(0,0,0,0.25); }
        .section-header { font-size: 15px; font-weight: 700; color: #111827; border-left: 4px solid #06C755; padding-left: 10px; margin: 20px 0 15px; }
        .settings-box { background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; margin-bottom: 16px; }
    </style>
</head>
<body>

<div id="app" v-cloak class="flex h-screen w-full">
    <!-- LOGIN -->
    <div v-if="!isLoggedIn" class="fixed inset-0 z-[1000] flex items-center justify-center bg-[#f0f2f5]">
        <div class="bg-white p-12 rounded-xl shadow-2xl w-[400px] text-center border">
            <h1 class="text-2xl font-bold text-gray-800 mb-6">運動島管理登入</h1>
            <input v-model="password" type="password" class="input-line mb-6" placeholder="管理密碼">
            <button @click="login" :disabled="isLoading" class="w-full btn-green justify-center py-3 shadow-lg">登入系統</button>
            <p v-if="error" class="text-red-500 text-sm mt-4 font-bold">{{ error }}</p>
        </div>
    </div>

    <!-- MAIN DASHBOARD -->
    <template v-else>
        <aside class="sidebar">
            <div class="p-6 font-black text-xl border-b tracking-tight">運動島管理站</div>
            <div class="flex-1 py-4">
                <div class="menu-item" :class="{active: currentTab==='courses'}" @click="currentTab='courses'"><i class="fas fa-book-open mr-3"></i> 課程管理</div>
                <div class="menu-item" :class="{active: currentTab==='orders'}" @click="currentTab='orders'"><i class="fas fa-money-check-alt mr-3"></i> 訂單管理</div>
                <div class="menu-item" :class="{active: currentTab==='members'}" @click="currentTab='members'"><i class="fas fa-users-cog mr-3"></i> 會員管理</div>
            </div>
            <div class="p-4 border-t"><button @click="logout" class="w-full btn-white text-xs py-1">登出</button></div>
        </aside>

        <main class="main-content">
            <header class="top-header">
                <h2 class="text-xl font-bold text-gray-800">{{ tabName }}</h2>
                <button @click="fetchData" class="btn-white"><i class="fas fa-sync-alt" :class="{'fa-spin':isLoading}"></i> 資料同步</button>
            </header>
            
            <div class="content-scroll">
                <!-- 課程管理列表 -->
                <div v-if="currentTab==='courses'">
                    <div class="flex justify-between mb-6 items-end"><div class="text-lg font-bold">上架課程：{{ courses.length }}</div><button @click="openAddCourse" class="btn-green shadow-sm"><i class="fas fa-plus"></i> 新增課程</button></div>
                    <div class="card">
                        <table class="data-table">
                            <thead><tr><th>課程資訊</th><th>類型/時間</th><th>費用/名額</th><th class="text-right">操作</th></tr></thead>
                            <tbody>
                                <tr v-for="c in courses" :key="c.id">
                                    <td class="font-bold w-1/3">{{ c.name }}<br><span class="text-[10px] text-gray-400 font-mono">{{ c.id }}</span></td>
                                    <td><span class="text-xs bg-blue-50 text-blue-600 px-2 rounded">{{ c.type }}</span><div class="text-xs text-gray-500 mt-1">{{ c.startDate }} ~ {{ c.endDate }}</div></td>
                                    <td><div class="text-[#06C755] font-bold">${{ c.price }}</div><div class="text-[10px] text-gray-400">{{ c.enrolled }} / {{ c.capacity }} 人</div></td>
                                    <td class="text-right"><button @click="openEditCourse(c)" class="text-blue-500 hover:underline px-2"><i class="fas fa-edit"></i> 編輯</button></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 訂單管理列表 -->
                <div v-if="currentTab==='orders'">
                    <div class="card">
                        <table class="data-table">
                            <thead><tr><th>單號</th><th>學員</th><th>金額</th><th>狀態</th><th>後五碼</th><th class="text-right">操作</th></tr></thead>
                            <tbody>
                                <tr v-for="o in orders" :key="o.orderId">
                                    <td class="text-xs font-mono">{{ o.orderId.slice(0,8) }}</td>
                                    <td class="font-bold">{{ o.name }}<br><span class="text-[10px] text-gray-400">{{ o.phone }}</span></td>
                                    <td class="text-[#06C755] font-bold">${{ o.amount }}</td>
                                    <td><span :class="getStatusClass(o.status)" class="px-2 py-1 rounded text-[10px] font-bold">{{ getStatusLabel(o.status) }}</span></td>
                                    <td class="font-mono">{{ o.remittance || '-' }}</td>
                                    <td class="text-right"><button @click="openOrder(o)" class="btn-white text-xs">編輯</button></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 會員管理列表 -->
                <div v-if="currentTab==='members'">
                    <div class="card">
                        <table class="data-table">
                            <thead><tr><th>姓名</th><th>手機</th><th>身分證</th><th class="text-center">家人</th><th class="text-right">操作</th></tr></thead>
                            <tbody>
                                <tr v-for="u in users" :key="u.userId">
                                    <td class="font-bold">{{ u.name }}</td><td>{{ u.phone }}</td><td>{{ u.nationalId }}</td>
                                    <td class="text-center"><span class="bg-gray-100 px-2 py-0.5 rounded text-xs font-bold">{{ u.familyMembers?.length || 0 }}</span></td>
                                    <td class="text-right"><button @click="openMember(u)" class="text-blue-600 hover:underline">詳情</button></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </template>

    <!-- --- MODALS --- -->

    <!-- 課程新增/編輯 (重點：設備租用列表化) -->
    <div v-if="showCourseModal" class="modal-mask">
        <div class="modal-pop">
            <div class="h-14 border-b px-6 flex justify-between items-center shrink-0 bg-white"><h3 class="font-black text-lg text-gray-800">{{ isEditingCourse ? '編輯課程詳情' : '建立新課程' }}</h3><button @click="showCourseModal=false" class="text-gray-400 hover:rotate-90 transition duration-200"><i class="fas fa-times text-xl"></i></button></div>
            <div class="flex-1 flex overflow-hidden">
                <!-- 左側：基本設定 -->
                <div class="w-1/2 p-8 overflow-y-auto border-r bg-white">
                    <div class="section-header">基本資訊</div>
                    <div class="grid grid-cols-2 gap-6 mb-6">
                        <div><label class="label-line">課程 ID</label><input v-model="courseForm.id" class="input-line" :readonly="isEditingCourse" placeholder="例: CAMP2025_01"></div>
                        <div><label class="label-line">課程名稱</label><input v-model="courseForm.name" class="input-line"></div>
                        <div><label class="label-line">類型</label><select v-model="courseForm.type" class="input-line"><option value="單日課程">單日課程</option><option value="多日營隊">多日營隊</option><option value="常態課後">常態課後</option></select></div>
                        <div><label class="label-line">時段</label><select v-model="courseForm.timeSlotType" class="input-line"><option value="全日">全日 (09:00-16:00)</option><option value="上午">上午 (09:00-12:00)</option><option value="下午">下午 (13:30-16:30)</option><option value="晚間">晚間</option></select></div>
                    </div>
                    <div class="grid grid-cols-2 gap-6 mb-6">
                        <div><label class="label-line">開始日期</label><input v-model="courseForm.startDate" type="date" class="input-line"></div>
                        <div><label class="label-line">結束日期</label><input v-model="courseForm.endDate" type="date" class="input-line"></div>
                        <div><label class="label-line">開始時間</label><input v-model="courseForm.startTime" placeholder="09:00" class="input-line"></div>
                        <div><label class="label-line">結束時間</label><input v-model="courseForm.endTime" placeholder="16:00" class="input-line"></div>
                    </div>
                    <div class="section-header">地點與師資</div>
                    <div class="grid grid-cols-2 gap-6 mb-6">
                        <div><label class="label-line">上課地點</label><input v-model="courseForm.location" class="input-line"></div>
                        <div><label class="label-line">教練/老師</label><input v-model="courseForm.instructor" class="input-line"></div>
                    </div>
                </div>
                <!-- 右側：費用與設備 (優化重點) -->
                <div class="w-1/2 p-8 overflow-y-auto bg-[#fafafa]">
                    <div class="section-header">費用與人數</div>
                    <div class="grid grid-cols-2 gap-6 mb-6">
                        <div><label class="label-line">課程原價</label><input v-model="courseForm.price" type="number" class="input-line font-bold"></div>
                        <div><label class="label-line">名額上限</label><input v-model="courseForm.capacity" type="number" class="input-line"></div>
                        <div><label class="label-line">總堂數 (扣款用)</label><input v-model="courseForm.totalSessions" type="number" class="input-line"></div>
                    </div>
                    <div class="settings-box">
                        <div class="font-bold text-xs mb-3 text-orange-600 flex items-center"><i class="fas fa-bolt mr-1"></i> 早鳥優惠設定</div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="label-line">早鳥優惠價 (0為無)</label><input v-model="courseForm.earlyBirdPrice" type="number" class="input-line"></div>
                            <div><label class="label-line">截止日期</label><input v-model="courseForm.earlyBirdDate" type="date" class="input-line"></div>
                        </div>
                    </div>

                    <div class="section-header flex justify-between items-center">
                        <span>設備租用清單</span>
                        <button @click="addEquipment" class="text-xs bg-[#06C755]/10 text-[#06C755] px-3 py-1 rounded-full font-bold hover:bg-[#06C755] hover:text-white transition">新增設備項目</button>
                    </div>
                    <div class="space-y-3 mb-6">
                        <div v-for="(eq, idx) in courseEquipments" :key="idx" class="flex gap-2 items-end bg-white p-3 rounded border border-gray-200 shadow-sm">
                            <div class="flex-1"><label class="label-line">設備名稱</label><input v-model="eq.name" class="input-line text-sm" placeholder="如：球拍、直排輪"></div>
                            <div class="w-24"><label class="label-line">租借費</label><input v-model="eq.price" type="number" class="input-line text-sm"></div>
                            <button @click="removeEquipment(idx)" class="w-9 h-9 flex items-center justify-center text-red-400 hover:bg-red-50 rounded-lg transition"><i class="fas fa-trash-alt"></i></button>
                        </div>
                        <div v-if="courseEquipments.length===0" class="text-center py-6 text-xs text-gray-400 border-2 border-dashed rounded-lg">目前無加購設備項目</div>
                    </div>

                    <div class="section-header">宣傳與說明</div>
                    <div class="mb-4"><label class="label-line">封面圖片網址</label><input v-model="courseForm.image" class="input-line text-xs" placeholder="https://..."></div>
                    <div><label class="label-line">詳細課程描述</label><textarea v-model="courseForm.description" rows="4" class="input-line text-sm"></textarea></div>
                </div>
            </div>
            <div class="h-16 border-t px-8 flex justify-end items-center gap-4 shrink-0 bg-white shadow-lg"><button @click="showCourseModal=false" class="btn-white px-8">取消</button><button @click="saveCourse" :disabled="isLoading" class="btn-green px-12 justify-center">{{ isLoading ? '儲存中...' : '確認儲存課程資料' }}</button></div>
        </div>
    </div>

    <!-- 會員詳情與家人編輯 (包含鉛筆按鈕) -->
    <div v-if="showMemberModal" class="modal-mask">
        <div class="modal-pop" style="max-width:1100px; height:85%;">
            <div class="h-14 border-b px-6 flex justify-between items-center shrink-0 bg-white"><h3 class="font-bold">會員資料管理</h3><button @click="showMemberModal=false"><i class="fas fa-times"></i></button></div>
            <div class="flex-1 flex overflow-hidden">
                <div class="w-1/2 p-8 overflow-y-auto border-r bg-white">
                    <div class="section-header">家長主帳號</div>
                    <div class="grid grid-cols-2 gap-6 mb-6">
                        <div><label class="label-line">姓名</label><input v-model="editingMember.name" class="input-line"></div>
                        <div><label class="label-line text-gray-400">身分證 (不可修改)</label><input v-model="editingMember.nationalId" class="input-line bg-gray-50" readonly></div>
                        <div><label class="label-line">聯絡電話</label><input v-model="editingMember.phone" class="input-line"></div>
                        <div><label class="label-line">生日</label><input v-model="editingMember.birthday" type="date" class="input-line"></div>
                    </div>
                </div>
                <div class="w-1/2 p-8 overflow-y-auto bg-[#f9fafb]">
                    <div class="section-header">子女/關聯家人名冊</div>
                    <div v-for="fm in editingMember.familyMembers" :key="fm.userId" class="bg-white p-4 rounded-xl border mb-3 flex justify-between items-center shadow-sm hover:border-[#06C755] transition">
                        <div><div class="font-bold text-gray-800 text-base">{{ fm.name }} <span class="text-xs text-[#06C755] font-normal ml-1">({{ fm.relation }})</span></div><div class="text-[10px] text-gray-400 mt-1">ID: {{ fm.nationalId }} | 生日: {{ fm.birthday }}</div></div>
                        <button @click="openRelativeEdit(fm)" class="w-10 h-10 flex items-center justify-center text-blue-500 hover:bg-blue-50 rounded-full transition shadow-sm border border-blue-100"><i class="fas fa-pen text-sm"></i></button>
                    </div>
                </div>
            </div>
            <div class="p-4 border-t flex justify-end bg-white"><button @click="saveMember" class="btn-green px-10">確認儲存</button></div>
        </div>
    </div>

    <!-- 親人編輯 (獨立視窗) -->
    <div v-if="showRelativeModal" class="modal-mask" style="z-index: 10000;">
        <div class="modal-pop" style="max-width:400px; height: auto;">
            <div class="h-14 px-6 border-b flex justify-between items-center"><b>修改子女資訊</b><button @click="showRelativeModal=false"><i class="fas fa-times text-gray-400"></i></button></div>
            <div class="p-6 space-y-5 bg-[#fafafa]">
                <div><label class="label-line">真實姓名</label><input v-model="editingRelative.name" class="input-line"></div>
                <div><label class="label-line">身分證 (比對用)</label><input v-model="editingRelative.nationalId" class="input-line bg-gray-50" readonly></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="label-line">關係</label><input v-model="editingRelative.relation" class="input-line"></div>
                    <div><label class="label-line">性別</label><select v-model="editingRelative.gender" class="input-line"><option value="男">男</option><option value="女">女</option></select></div>
                </div>
                <div><label class="label-line">出生日期</label><input v-model="editingRelative.birthday" type="date" class="input-line"></div>
            </div>
            <div class="p-4 border-t flex justify-end gap-3 bg-white"><button @click="showRelativeModal=false" class="btn-white">取消</button><button @click="saveRelative" class="btn-green px-8">確認修改</button></div>
        </div>
    </div>

    <!-- 訂單編輯 (獨立視窗) -->
    <div v-if="showOrderModal" class="modal-mask">
        <div class="modal-pop" style="max-width:550px; height: auto;">
            <div class="h-14 px-6 border-b flex justify-between items-center bg-white"><h3 class="font-bold">編輯報名狀態</h3><button @click="showOrderModal=false"><i class="fas fa-times text-gray-400"></i></button></div>
            <div class="p-8 space-y-6 bg-[#fafafa]">
                <div class="grid grid-cols-2 gap-6">
                    <div><label class="label-line text-xs">付款狀態</label><select v-model="editingOrder.status" class="input-line text-sm"><option value="PENDING">待付款</option><option value="PAID">已入帳</option><option value="CANCELLED">取消報名</option></select></div>
                    <div><label class="label-line text-xs">實收金額</label><input v-model="editingOrder.amount" type="number" class="input-line text-[#06C755] font-bold"></div>
                </div>
                <div><label class="label-line text-xs">管理員內部備註</label><textarea v-model="editingOrder.note" rows="3" class="input-line text-sm"></textarea></div>
            </div>
            <div class="p-6 border-t flex justify-end gap-3 bg-white"><button @click="showOrderModal=false" class="btn-white">關閉</button><button @click="saveOrder" class="btn-green px-10">儲存變更</button></div>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, computed, onMounted } = Vue;
    const API_ENDPOINT = 'https://sport-island.fangwl591021.workers.dev/'; 

    createApp({
        setup() {
            const isLoggedIn=ref(false), password=ref(''), isLoading=ref(false), error=ref(''), currentTab=ref('courses');
            const courses=ref([]), orders=ref([]), users=ref([]);
            
            const showCourseModal=ref(false), isEditingCourse=ref(false), courseForm=ref({}), courseEquipments=ref([]);
            const showMemberModal=ref(false), editingMember=ref({});
            const showOrderModal=ref(false), editingOrder=ref({});
            const showRelativeModal=ref(false), editingRelative=ref({});

            const callApi = async (action, payload={}) => {
                const res = await fetch(API_ENDPOINT, { method:'POST', body:JSON.stringify({action, payload:{password:password.value, ...payload}}) });
                const json = await res.json();
                if(json.status!=='success') throw new Error(json.message);
                return json.data;
            };

            const login = async () => { isLoading.value=true; try { await callApi('ADMIN_LOGIN'); isLoggedIn.value=true; fetchData(); } catch(e){ error.value='管理密碼錯誤'; } finally { isLoading.value=false; } };
            const logout = () => { isLoggedIn.value=false; password.value=''; };
            const fetchData = async () => { isLoading.value=true; try { const d = await callApi('ADMIN_GET_DATA'); courses.value=d.courses; orders.value=d.orders.reverse(); users.value=d.users; } catch(e){ alert('連線失敗，請稍後再試'); } finally { isLoading.value=false; } };

            // 課程邏輯
            const openAddCourse = () => { isEditingCourse.value=false; courseForm.value={id:'', name:'', startDate:'', endDate:'', price:0, capacity:0, totalSessions:1, type:'單日課程', timeSlotType:'全日', earlyBirdPrice:0, earlyBirdDate:'', equipmentJson:'[]'}; courseEquipments.value=[]; showCourseModal.value=true; };
            const openEditCourse = (c) => { isEditingCourse.value=true; courseForm.value = {...c}; try { courseEquipments.value = JSON.parse(c.equipmentJson || '[]'); } catch(e){ courseEquipments.value=[]; } showCourseModal.value=true; };
            const addEquipment = () => { courseEquipments.value.push({name:'', price:0}); };
            const removeEquipment = (i) => { courseEquipments.value.splice(i, 1); };
            const saveCourse = async () => { 
                isLoading.value=true;
                try { 
                    courseForm.value.equipmentJson = JSON.stringify(courseEquipments.value);
                    const act = isEditingCourse.value ? 'ADMIN_UPDATE_COURSE' : 'ADMIN_ADD_COURSE'; 
                    await callApi(act, courseForm.value); alert('課程資料已存檔'); showCourseModal.value=false; fetchData(); 
                } catch(e){ alert('存檔失敗'); } finally { isLoading.value=false; }
            };

            // 會員邏輯
            const openMember = (u) => { editingMember.value = JSON.parse(JSON.stringify(u)); showMemberModal.value=true; };
            const saveMember = async () => { try { await callApi('ADMIN_UPDATE_MEMBER', {memberData:editingMember.value}); alert('更新成功'); showMemberModal.value=false; fetchData(); } catch(e){ alert('錯誤'); } };
            const openRelativeEdit = (fm) => { editingRelative.value = {...fm}; showRelativeModal.value=true; };
            const saveRelative = async () => { try { await callApi('ADMIN_UPDATE_MEMBER', {memberData:editingRelative.value}); alert('子女資料已更新'); showRelativeModal.value=false; fetchData(); } catch(e){ alert('錯誤'); } };

            // 訂單邏輯
            const openOrder = (o) => { editingOrder.value = {...o}; showOrderModal.value=true; };
            const saveOrder = async () => { try { await callApi('ADMIN_UPDATE_ORDER', {orderData:editingOrder.value}); alert('更新成功'); showOrderModal.value=false; fetchData(); } catch(e){ alert('更新失敗'); } };

            const tabName = computed(() => ({'courses':'課程管理','orders':'訂單管理','members':'會員管理'}[currentTab.value]));
            const getStatusLabel = s => ({'PENDING':'待付','PAID':'完款','CANCELLED':'取消'}[s]||s);
            const getStatusClass = s => ({'PENDING':'bg-yellow-100 text-yellow-800','PAID':'bg-green-100 text-green-800','CANCELLED':'bg-gray-100 text-gray-500'}[s]);

            return { isLoggedIn, password, isLoading, error, currentTab, tabName, courses, orders, users, showCourseModal, isEditingCourse, courseForm, courseEquipments, showMemberModal, editingMember, showOrderModal, editingOrder, showRelativeModal, editingRelative, login, logout, fetchData, openAddCourse, openEditCourse, addEquipment, removeEquipment, saveCourse, openMember, saveMember, openOrder, saveOrder, openRelativeEdit, saveRelative, getStatusLabel, getStatusClass };
        }
    }).mount('#app');
</script>
</body>
</html>
