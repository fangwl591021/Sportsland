<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>竹北運動中心 - 管理員後台</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        [v-cloak] { display: none; }
        .sidebar-link { @apply flex items-center py-3 px-4 rounded transition duration-200 hover:bg-gray-700 hover:text-white cursor-pointer mb-2; }
        .sidebar-link.active { @apply bg-blue-600 text-white shadow-lg; }
        .status-badge { @apply px-2 py-1 rounded text-xs font-bold; }
        .input-std { @apply w-full border border-gray-300 p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none text-sm; }
        .label-std { @apply block text-xs font-bold text-gray-500 uppercase mb-1; }
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-800">

<div id="app" v-cloak class="min-h-screen flex flex-col">

    <!-- Login -->
    <div v-if="!isLoggedIn" class="flex-grow flex items-center justify-center bg-gray-800">
        <div class="bg-white p-8 rounded-lg shadow-xl w-96">
            <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">管理員登入</h2>
            <form @submit.prevent="login">
                <input v-model="password" type="password" class="shadow border rounded w-full py-2 px-3 mb-4" placeholder="密碼">
                <button :disabled="isLoading" class="w-full bg-blue-600 text-white font-bold py-2 rounded">登入</button>
            </form>
        </div>
    </div>

    <!-- Dashboard -->
    <div v-else class="flex flex-grow h-screen overflow-hidden">
        <aside class="w-64 bg-gray-900 text-gray-400 flex flex-col shrink-0">
            <div class="p-4 bg-gray-800 font-bold text-white text-lg">營隊管理</div>
            <nav class="flex-grow p-4">
                <a @click="currentTab='courses'" :class="{'active':currentTab==='courses'}" class="sidebar-link"><i class="fas fa-chalkboard-teacher mr-2"></i> 課程</a>
                <a @click="currentTab='orders'" :class="{'active':currentTab==='orders'}" class="sidebar-link"><i class="fas fa-file-invoice-dollar mr-2"></i> 訂單</a>
                <a @click="currentTab='members'" :class="{'active':currentTab==='members'}" class="sidebar-link"><i class="fas fa-users mr-2"></i> 會員</a>
            </nav>
            <div class="p-4 border-t border-gray-800"><button @click="logout" class="text-sm w-full text-left">登出</button></div>
        </aside>

        <main class="flex-grow flex flex-col overflow-hidden w-full bg-gray-100">
            <header class="bg-white shadow p-4 flex justify-between items-center z-10">
                <h2 class="text-xl font-bold">{{ tabName }}</h2>
                <button @click="fetchData" class="text-blue-600 text-sm"><i class="fas fa-sync-alt" :class="{'fa-spin':isLoading}"></i> 重整</button>
            </header>

            <div class="flex-grow overflow-auto p-6">
                <!-- Courses -->
                <div v-if="currentTab==='courses'">
                    <div class="mb-4 font-bold text-lg">總課程: {{ courses.length }}</div>
                    <table class="min-w-full bg-white shadow rounded">
                        <thead class="bg-gray-100 border-b"><tr><th class="p-3 text-left">ID</th><th class="p-3 text-left">名稱</th><th class="p-3 text-left">價格</th><th class="p-3 text-left">狀況</th></tr></thead>
                        <tbody><tr v-for="c in courses" :key="c.id" class="border-b"><td class="p-3">{{c.id}}</td><td class="p-3 font-bold">{{c.name}}</td><td class="p-3 text-green-600">${{c.price}}</td><td class="p-3">{{c.enrolled}}/{{c.capacity}}</td></tr></tbody>
                    </table>
                </div>

                <!-- Orders -->
                <div v-if="currentTab==='orders'">
                    <table class="min-w-full bg-white shadow rounded">
                        <thead class="bg-gray-100 border-b"><tr><th class="p-3 text-left">訂單</th><th class="p-3 text-left">學員</th><th class="p-3 text-left">狀態</th><th class="p-3 text-left">操作</th></tr></thead>
                        <tbody><tr v-for="o in orders" :key="o.orderId" class="border-b"><td class="p-3">{{o.orderId.slice(0,8)}}</td><td class="p-3">{{o.name}}</td><td class="p-3"><span class="status-badge" :class="getStatusClass(o.status)">{{o.status}}</span></td><td class="p-3"><button v-if="o.status!=='CANCELLED'" @click="updateStatus(o.orderId,'CANCELLED')" class="text-red-500 text-xs">取消</button></td></tr></tbody>
                    </table>
                </div>

                <!-- Members -->
                <div v-if="currentTab==='members'">
                    <table class="min-w-full bg-white shadow rounded">
                        <thead class="bg-gray-100 border-b"><tr><th class="p-3 text-left">姓名</th><th class="p-3 text-left">身分證</th><th class="p-3 text-left">家人數</th><th class="p-3 text-left">操作</th></tr></thead>
                        <tbody>
                            <tr v-for="u in users" :key="u.userId" class="border-b">
                                <td class="p-3 font-bold">{{u.name}}</td>
                                <td class="p-3 font-mono">{{u.nationalId}}</td>
                                <td class="p-3">{{u.familyMembers ? u.familyMembers.length : 0}}</td>
                                <td class="p-3"><button @click="openMember(u)" class="bg-blue-100 text-blue-600 px-2 py-1 rounded text-xs">查看</button></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Member Modal -->
    <div v-if="showMemberModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white w-[800px] h-[80vh] rounded flex flex-col overflow-hidden">
            <div class="bg-blue-600 p-4 text-white font-bold flex justify-between">
                <span>會員資料</span><button @click="showMemberModal=false"><i class="fas fa-times"></i></button>
            </div>
            <div class="flex flex-grow overflow-hidden">
                <div class="w-1/2 p-6 overflow-y-auto border-r bg-gray-50">
                    <h4 class="font-bold border-b pb-2 mb-4">主帳號資料</h4>
                    <form @submit.prevent="saveMember" class="space-y-3">
                        <div><label class="label-std">姓名</label><input v-model="editingMember.name" class="input-std"></div>
                        <div><label class="label-std">身分證</label><input v-model="editingMember.nationalId" class="input-std bg-gray-200" readonly></div>
                        <div><label class="label-std">電話</label><input v-model="editingMember.phone" class="input-std"></div>
                        <div><label class="label-std">地址</label><input v-model="editingMember.address" class="input-std"></div>
                        <button class="w-full bg-blue-600 text-white py-2 rounded font-bold mt-4">儲存主帳號變更</button>
                    </form>
                </div>
                <div class="w-1/2 p-6 overflow-y-auto">
                    <h4 class="font-bold border-b pb-2 mb-4">家人列表 ({{editingMember.familyMembers.length}})</h4>
                    <div v-for="fm in editingMember.familyMembers" class="bg-gray-100 p-3 rounded mb-2 text-sm border">
                        <div class="font-bold flex justify-between"><span>{{fm.name}}</span> <span class="text-xs bg-gray-200 px-1 rounded">{{fm.relation}}</span></div>
                        <div class="text-xs text-gray-500 mt-1">ID: {{fm.nationalId}} | 生日: {{formatDate(fm.birthday)}}</div>
                        <div v-if="fm.healthStatus==='需備註'" class="text-xs text-red-500 mt-1">健康: {{fm.healthNote}}</div>
                    </div>
                    <div v-if="editingMember.familyMembers.length===0" class="text-gray-400 italic">無家人資料</div>
                </div>
            </div>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, computed } = Vue;
    const API_ENDPOINT = 'https://sport-island.fangwl591021.workers.dev/'; 

    createApp({
        setup() {
            const isLoggedIn=ref(false), password=ref(''), isLoading=ref(false), currentTab=ref('courses');
            const courses=ref([]), orders=ref([]), users=ref([]);
            const showMemberModal=ref(false), editingMember=ref({});

            const tabName = computed(()=>({'courses':'課程','orders':'訂單','members':'會員'}[currentTab.value]));

            const login = async () => {
                isLoading.value=true;
                const res = await fetch(API_ENDPOINT, { method:'POST', body:JSON.stringify({action:'ADMIN_LOGIN', payload:{password:password.value}}) });
                const json = await res.json();
                if(json.status==='success') { isLoggedIn.value=true; fetchData(); } else alert('密碼錯誤');
                isLoading.value=false;
            };
            const logout = () => isLoggedIn.value=false;

            const fetchData = async () => {
                isLoading.value=true;
                const res = await fetch(API_ENDPOINT, { method:'POST', body:JSON.stringify({action:'ADMIN_GET_DATA', payload:{password:password.value}}) });
                const json = await res.json();
                if(json.status==='success') { courses.value=json.data.courses; orders.value=json.data.orders; users.value=json.data.users; }
                isLoading.value=false;
            };

            const updateStatus = async (oid, st) => {
                if(!confirm('確認?')) return;
                await fetch(API_ENDPOINT, { method:'POST', body:JSON.stringify({action:'ADMIN_UPDATE_ORDER', payload:{password:password.value, orderId:oid, newStatus:st}}) });
                fetchData();
            };

            const openMember = (u) => { editingMember.value = JSON.parse(JSON.stringify(u)); showMemberModal.value=true; };
            const saveMember = async () => {
                await fetch(API_ENDPOINT, { method:'POST', body:JSON.stringify({action:'ADMIN_UPDATE_MEMBER', payload:{password:password.value, memberData:editingMember.value}}) });
                alert('已儲存'); showMemberModal.value=false; fetchData();
            };

            return { 
                isLoggedIn, password, isLoading, currentTab, tabName, courses, orders, users, 
                showMemberModal, editingMember, login, logout, fetchData, updateStatus, openMember, saveMember,
                formatDate: d=>d?new Date(d).toLocaleDateString():'-',
                getStatusClass: s=>({'PENDING':'bg-yellow-100','PAID':'bg-green-100','CANCELLED':'bg-gray-200'}[s])
            };
        }
    }).mount('#app');
</script>
</body>
</html>
